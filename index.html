<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Account Management System | Login</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/9131/9131478.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.43/moment-timezone-with-data.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Karla:ital,wght@0,200..800;1,200..800&display=swap');
:root {
    --primary: #00FFFF;
    --primary-dark: #00B3B3;
    --primary-light: #2c5050;
    --danger: #FF6B6B;
    --danger-light: #441a1a;
    --success: #3DED97;
    --warning: #FFC300;
    --muted: #A0A0A0;
    --light: #f7f9fc;
    --bg: #1A1A1A;
    --card: rgba(255, 255, 255, 0.08);
    --card-hover: rgba(255, 255, 255, 0.15);
    --text: #EAEAEA;
    --text-light: #B0B0B0;
    --border: rgba(255, 255, 255, 0.15);
    --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    --shadow-hover: 0 12px 48px 0 rgba(0, 0, 0, 0.45);
    --radius: 16px;
    --radius-sm: 8px;
    --transition: all 0.3s ease-in-out;
}
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}
body {
    font-family: "Poppins", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    line-height: 1.7;
    color: var(--text);
    background-color: var(--bg);
    background-image: url("https://static.vecteezy.com/system/resources/previews/048/238/573/non_2x/abstract-futuristic-technology-blank-wallpaper-free-vector.jpg");
    background-size: cover;
    background-repeat: no-repeat;
    background-attachment: fixed;
    background-position: center center;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
}
::-webkit-scrollbar {
    width: 5px;
    height: 12px;
}

::-webkit-scrollbar-track {
    background: transparent;
    border-radius: 10px;
}

::-webkit-scrollbar-thumb {
    background: #555555;
    border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
    background: #777777;
}


#global-loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: opacity 0.5s ease;
}
#global-loader.hidden {
    opacity: 0;
    pointer-events: none;
}
#app-container {
    width: 100%;
    height: 100vh;
    overflow-y: auto;
    transition: opacity 0.5s ease, transform 0.5s ease;
}
#app-container.logging-out {
    opacity: 0;
    transform: scale(0.98);
}
.login-container {
    width: 100%;
    max-width: 400px;
    padding: 30px;
    border-radius: var(--radius);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    background: rgba(0, 0, 0, 0.3);
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    text-align: center;
}
.login-container h1 {
    margin-bottom: 25px;
    font-size: 1.8rem;
}
.login-container .input-group {
    margin-bottom: 20px;
    text-align: left;
}
.login-container label {
    display: block;
    margin-bottom: 5px;
    color: var(--text-light);
}
.login-container input {
    width: 100%;
    padding: 12px;
    border-radius: var(--radius-sm);
    border: 1.5px solid var(--border);
    font-size: 1rem;
    background: rgba(0, 0, 0, 0.4);
    color: var(--text);
}
.login-container input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(0, 255, 255, 0.2);
}
.login-container .btn.login {
    width: 30%;
    padding: 12px;
    font-size: 1.1rem;
    font-weight: 700;
    background: var(--primary);
    color: var(--bg);
}
.login-container .btn.login:hover {
    background: var(--primary-dark);
}
input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(1);
    cursor: pointer;
}
nav {
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    padding: 0 20px;
    display: flex;
    justify-content: center;
    position: sticky;
    top: 0;
    z-index: 100;
}
.nav-container-wrapper {
    display: flex;
    max-width: 1400px;
    width: 100%;
    align-items: center;
    justify-content: space-between;
}
.auth-actions {
    display: flex;
    align-items: center;
    gap: 10px;
}
.btn.nav-action-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-light);
    padding: 6px 12px;
    font-size: 0.9rem;
}
.btn.nav-action-btn:hover {
    background: var(--primary-light);
    color: var(--text);
}
.btn.export-btn {
    background: var(--primary-light);
    color: var(--text);
    padding: 10px 15px;
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 1rem;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    opacity:0.5;
}
.btn.export-btn:hover {
    background: rgba(0, 255, 255, 0.15);
    color: var(--primary);
    opacity:1;
}
.nav-tabs {
    display: flex;
}
.nav-tab {
    padding: 10px 10px;
    color: var(--text-light);
    text-decoration: none;
    font-weight: 600;
    font-size: 1.1rem;
    border-bottom: 3px solid transparent;
    transition: var(--transition);
    cursor: pointer;
    opacity:0.5;
}
.nav-tab:hover {
    color: var(--text);
    background: rgba(255, 255, 255, 0.05);
}
.nav-tab.active {
    color: var(--primary);
    border-bottom: 3px solid var(--primary);
    opacity:1;
    background: rgba(255, 255, 255, 0.1);
}
h1 {
    text-align: center;
    margin: 1.5rem 0 2rem;
    font-weight: 700;
    color: var(--primary);
    font-size: 2.2rem;
    text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
}
.clocks-container {
    display: flex;
    justify-content: center;
    gap: 30px;
    padding: 15px 0 20px;
    position: relative;
    z-index: 60;
    flex-wrap: wrap;
    background: rgba(0, 0, 0, 0.4);
    border-bottom: 1px solid var(--border);
}
.clock-wrapper {
    text-align: center;
    opacity: 0.9;
    transition: var(--transition);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}
.clock-label {
    font-weight: 600;
    font-size: 1rem;
    color: var(--text-light);
    letter-spacing: 1px;
}
.digital-time {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--primary);
    font-family: "Karla", sans-serif;
    font-optical-sizing: auto;
    font-weight: 400;
    font-style: normal;
    background: rgba(0, 255, 255, 0.1);
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    border: 2px dotted var(--primary-dark);
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
    min-width: 110px;
}
.month-tabs-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 10px 0 20px;
    margin-bottom: 20px;
    border-bottom: 1px solid var(--border);
    justify-content: flex-start;
    margin-top: -15px;
}
.month-tab {
    padding: 6px 6px;
    color: var(--text-light);
    text-decoration: none;
    font-weight: 500;
    font-size: 0.9rem;
    border: 1px solid transparent;
    border-radius: var(--radius-sm);
    transition: var(--transition);
    cursor: pointer;
    opacity: 0.7;
    white-space: nowrap;
}
.month-tab:hover {
    background: rgba(0, 255, 255, 0.1);
    color: var(--text);
    opacity: 1;
}
.month-tab.active {
    color: var(--primary);
    background: rgba(0, 255, 255, 0.2);
    border-color: var(--primary);
    font-weight: 600;
    opacity: 1;
}
.container {
    max-width: 95%;
    margin: 30px auto;
    padding: 30px;
    border-radius: var(--radius);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    background: rgba(0, 0, 0, 0.2);
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
    opacity: 1;
    transform: translateY(0);
}
main.container.fade-out {
    opacity: 0;
    transform: translateY(10px);
    pointer-events: none;
}
.data-reloading {
    transition: opacity 0.2s ease-in-out;
    opacity: 0.5;
}
.header-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 25px;
    flex-wrap: nowrap;
    gap: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border);
    flex-direction: row;
}
.summary-cards {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 30px;
    padding: 15px 0;
    border-bottom: 1px solid var(--border);
}

.summary-card {
    background: var(--card);
    padding: 12px 18px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    flex: 0 1 150px;
    aspect-ratio: 1.3 / 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    transition: all 0.2s ease;
}

.summary-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
}

.summary-card.danger { border-left: 4px solid var(--danger); }
.summary-card.success { border-left: 4px solid var(--success); }
.summary-card.warning { border-left: 4px solid var(--warning); }

.summary-card h4 {
    font-size: 0.9rem;
    color: var(--muted);
    margin-bottom: 6px;
    font-weight: 500;
    text-align: center;
}

.summary-card p {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--text);
    line-height: 1;
    text-align: center;
}

.summary-card p.success { color: var(--success); }
.summary-card p.warning { color: var(--warning); }
.summary-card p.danger { color: var(--danger); }

.search-container {
    display: flex;
    position: relative;
    flex: 1;
    min-width: 250px;
    max-width: 450px;
}

.search-container input {
    width: 100%;
    padding: 12px 16px 12px 42px;
    border-radius: var(--radius-sm);
    border: 1.5px solid var(--border);
    font-size: 1rem;
    transition: var(--transition);
    background: rgba(0, 0, 0, 0.4);
    color: var(--text);
}
.search-container input::placeholder {
    color: var(--text-light);
}
.search-container input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px var(--primary);
}
.search-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
}
.results-count {
    color: var(--muted);
    font-size: 1rem;
    white-space: nowrap;
    font-weight: 500;
}
.table-container {
    overflow-x: auto;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    position: relative;
    min-height: 150px;
    transition: opacity 0.3s ease-in-out;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}
table {
    width: 100%;
    border-collapse: collapse;
    min-width: 900px;
    background: rgba(0, 0, 0, 0.2);
}
thead {
    background: var(--primary-light);
    color: var(--text);
}
thead th {
    padding: 12px 10px;
    text-align: left;
    cursor: pointer;
    font-weight: 600;
    position: relative;
    transition: background 0.2s;
    white-space: nowrap;
}
thead th:hover {
    background: rgba(0, 255, 255, 0.15);
}
tbody td {
    padding: 8px 10px;
    vertical-align: middle;
    border-bottom: 1px solid var(--border);
    font-size: 0.95rem;
}
tbody td:nth-child(1),
tbody td:nth-child(2),
tbody td:nth-child(3) {
    cursor: copy;
}
tbody tr:nth-child(even) {
    background: rgba(0, 0, 0, 0.1);
}
tbody tr:hover {
    background: rgba(0, 255, 255, 0.05);
    box-shadow: inset 0 0 0 2px var(--primary);
}
tbody td strong {
    color: var(--primary);
}
tbody td:nth-child(1) a,
tbody td:nth-child(2) a,
tbody td:nth-child(3) a {
    color: inherit !important;
    text-decoration: none;
    cursor: copy !important;
}
tbody td a:hover {
    color: var(--primary) !important;
}
.sort-icon {
    margin-left: 6px;
    font-size: 0.85rem;
    opacity: 0.7;
    color: var(--primary);
}
.no-data {
    padding: 20px 18px;
    text-align: center;
    color: var(--muted);
    font-style: italic;
}
.badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    border: 1px solid transparent;
}
.timezone-badge {
    background: rgba(0, 255, 255, 0.2);
    color: var(--primary);
    border-color: var(--primary);
}
.badge.paid {
    background: rgba(61, 237, 151, 0.2);
    color: var(--success);
    border-color: var(--success);
}
.badge.chargeback {
    background: rgba(255, 107, 107, 0.2);
    color: var(--danger);
    border-color: var(--danger);
}
.cards-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    padding-top: 20px;
    display: none;
    position: relative;
    min-height: 100px;
    transition: opacity 0.3s ease-in-out;
}
@media (max-width: 950px) {
    .table-container { display: none; }
    .cards-container { display: grid; }
}
.account-card, .sales-card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    border-left: 4px solid var(--primary);
    transition: var(--transition);
}
.sales-card {
    border-left: 4px solid var(--success);
}
.card-field {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    border-bottom: 1px dotted var(--border);
}
.card-field:last-of-type {
    border-bottom: none;
}
.card-label {
    color: var(--muted);
    font-size: 0.9rem;
}
.card-value {
    text-align: right;
}
.card-value strong {
    color: var(--primary);
}
.card-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 15px;
}
.fab, .fab.sales {
    position: fixed;
    right: 20px;
    bottom: 20px;
    z-index: 220;
    background: var(--primary-dark);
    color: #fff;
    border: 0;
    border-radius: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    width: 45px;
    height: 45px;
    box-shadow: 0 8px 22px rgba(0, 255, 255, 0.3);
    cursor: pointer;
    transition: var(--transition);
    overflow: hidden;
    animation: pulse 1s infinite;
    font-family:Calibri;
    opacity:0.5;
}
.fab i {
    font-size: 20px;
    transition: transform 0.3s ease;
}
.fab .fab-text {
    opacity: 0;
    white-space: nowrap;
    transition: opacity 0.2s ease;
    font-size: 0.95rem;
    width: 0;
    overflow: hidden;
    font-size:20px;
    text-shadow:2px 2px 2px black;
}
.fab:hover {
    width: 175px;
    padding-left: 22px;
    padding-right: 22px;
    box-shadow: 0 12px 30px rgba(0, 255, 255, 0.5);
    transform: translateY(-2px);
    animation: none;
    opacity:1;
    border-radius: 15px;
}
.fab.sales:hover {
    box-shadow: 0 12px 30px rgba(61, 237, 151, 0.5);
}
.fab:hover .fab-text {
    opacity: 1;
    width: auto;
    margin-left: 10px;
}
.fab:hover i {
    transform: rotate(90deg);
}
.fab:active {
    transform: translateY(0);
}
@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(0, 255, 255, 0.4);
    }
    70% {
        box-shadow: 0 0 0 12px rgba(0, 255, 255, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(0, 255, 255, 0);
    }
}
.fab.sales {
    animation: pulse-sales 1s infinite;
}
@keyframes pulse-sales {
    0% {
        box-shadow: 0 0 0 0 rgba(61, 237, 151, 0.4);
    }
    70% {
        box-shadow: 0 0 0 12px rgba(61, 237, 151, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(61, 237, 151, 0);
    }
}
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    pointer-events: none;
}
.modal-overlay.show {
    opacity: 1;
    pointer-events: auto;
}
.modal {
    background: #1e1e1e;
    border: 1px solid var(--border);
    color: var(--text);
    padding: 30px;
    border-radius: var(--radius);
    width: 90%;
    max-width: 500px;
    box-shadow: var(--shadow-hover);
    transform: scale(0.95);
    transition: transform 0.3s ease-in-out;
}
.modal-overlay.show .modal {
    transform: scale(1);
}
.modal.sales-list-modal {
    max-width: 700px;
}
.modal h2 {
    color: var(--primary);
    border-bottom: 1px solid var(--border);
    padding-bottom: 10px;
    margin-bottom: 20px;
    font-size: 1.5rem;
    font-weight: 600;
}
.modal.sales-modal h2 {
    color: var(--success);
}
.modal label {
    display: block;
    margin-top: 15px;
    margin-bottom: 5px;
    font-weight: 500;
    color: var(--text-light);
}
.modal input, .modal select, .modal textarea {
    width: 100%;
    padding: 10px;
    border-radius: var(--radius-sm);
    background: rgba(0, 0, 0, 0.4);
    border: 1.5px solid var(--border);
    color: var(--text);
    font-size: 1rem;
    transition: var(--transition);
    resize: vertical;
}
.modal select {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    padding-right: 30px;
    background: rgba(0, 0, 0, 0.6) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3E%3Cpath fill='%23EAEAEA' d='M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z'/%3E%3C/svg%3E") no-repeat right 10px center;
    background-size: 14px 14px;
    color: var(--text);
}
.modal select option {
    background: #1A1A1A;
    color: var(--text);
}
.modal input:focus, .modal select:focus, .modal textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(0, 255, 255, 0.2);
}
.modal.sales-modal input:focus, .modal.sales-modal select:focus, .modal.sales-modal textarea:focus {
    border-color: var(--success);
    box-shadow: 0 0 0 3px rgba(61, 237, 151, 0.2);
}
.modal .row {
    display: flex;
    gap: 20px;
}
.modal .row > div {
    flex: 1;
}
.actions {
    margin-top: 30px;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}
.btn {
    padding: 10px 20px;
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 1rem;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
}
.btn.save {
    background: var(--primary);
    color: var(--bg);
    font-weight: 700;
}
.modal.sales-modal .btn.save {
    background: var(--success);
}
.btn.save:hover:not(:disabled) {
    background: var(--primary-dark);
}
.modal.sales-modal .btn.save:hover:not(:disabled) {
    background: #30b07a;
}
.btn.save:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
.btn.cancel {
    background: var(--primary-light);
    color: var(--text);
}
.btn.cancel:hover {
    background: rgba(255, 255, 255, 0.2);
}
#toastContainer {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 90%;
    min-width: 250px;
}
.toast {
    background-color: #2c2c2c;
    padding: 12px 20px;
    border-radius: var(--radius-sm);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    opacity: 0;
    transform: translateY(20px);
    animation: fadeInOut 4s ease-in-out forwards;
    display: flex;
    align-items: center;
    gap: 10px;
}
@keyframes fadeInOut {
    0% { opacity: 0; transform: translateY(20px); }
    10% { opacity: 1; transform: translateY(0); }
    90% { opacity: 1; transform: translateY(0); }
    100% { opacity: 0; transform: translateY(20px); }
}
.toast.success { border-color: var(--success); color: var(--success); }
.toast.danger { border-color: var(--danger); color: var(--danger); }
.toast.info { border-color: var(--primary); color: var(--primary); }
.toast span { color: var(--text); }
.data-loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(26, 26, 26, 0.85);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 50;
}
.data-loading-overlay.active {
    display: flex;
}
.data-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
.spinner {
    width: 15px;
    height: 15px;
    border: 2px solid rgba(255, 255, 255, 0.5);
    border-top-color: var(--bg);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    display: inline-block;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}
.action-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px 8px;
    border-radius: var(--radius-sm);
    font-size: 1rem;
    transition: var(--transition);
    opacity: 0.8;
}
tbody tr:hover .action-btn {
    opacity: 1;
}
.action-btn.edit { color: var(--primary); }
.action-btn.delete { color: var(--danger); }
.action-btn.view-sales { color: var(--success); }
.action-btn.view-sales:hover {
    background: rgba(61, 237, 151, 0.1);
    color: #30b07a;
}
.action-btn.edit:hover {
    background: rgba(0, 255, 255, 0.1);
    color: var(--primary-dark);
}
.action-btn.sales-edit { color: var(--success); }
.action-btn.sales-edit:hover {
    background: rgba(61, 237, 151, 0.1);
    color: #30b07a;
}
.action-btn.delete:hover {
    background: rgba(255, 107, 107, 0.1);
    color: var(--danger);
}
.card-actions .action-btn {
    opacity: 1;
}
#nprogress .bar {
    background: #3498db;
    height: 3px;
}
/* === Modal processing overlay === */
.modal.processing {
    pointer-events: none;          /* block clicks */
    opacity: 0.6;                  /* fade content slightly */
    transition: opacity 0.2s ease;
    position: relative;
}
.modal.processing::after {
    content: "";
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.3);   /* dim layer */
    z-index: 10;
    border-radius: inherit;
}
/* ✅ Success checkmark animation */
.btn.save.success-check {
    background: var(--success);
    color: var(--bg);
    position: relative;
    pointer-events: none;
}

.success-check i {
    animation: pop-in 0.4s ease forwards;
}

@keyframes pop-in {
    0% { transform: scale(0); opacity: 0; }
    60% { transform: scale(1.3); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
}

@media (max-width: 1200px) {
    .container {
        padding: 20px;
        margin: 20px auto;
    }
}
@media (max-width: 950px) {
    h1 {
        font-size: 1.8rem;
        margin: 1rem 0 1.5rem;
    }
    .clocks-container {
        padding: 10px 10px 15px;
        gap: 20px;
        justify-content: space-around;
    }
    .digital-time {
        font-size: 1.2rem;
        padding: 6px 12px;
        min-width: 100px;
    }
    .clock-label {
        font-size: 0.9rem;
    }
    nav {
        padding: 0 10px;
    }
    .nav-tab {
        font-size: 1rem;
        padding: 10px 8px;
    }
    .btn.export-btn {
        padding: 8px 12px;
        font-size: 0.9rem;
    }
    .summary-cards {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
    }
    .summary-card p {
        font-size: 1.3rem;
    }
    .header-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
    }
    .search-container {
        max-width: none;
        width: 100%;
    }
    .results-count {
        text-align: center;
        margin-bottom: 5px;
    }
    .account-card, .sales-card {
        padding: 15px;
        border-radius: var(--radius-sm);
    }
}
@media (max-width: 768px) {
    .nav-container-wrapper {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
        padding: 10px 0;
    }
    .nav-tabs {
        order: 2;
        justify-content: center;
    }
    .auth-actions {
        order: 1;
        justify-content: flex-end;
    }
}
@media (max-width: 600px) {
    .container {
        padding: 15px;
        margin: 15px auto;
    }
    .nav-tabs {
        flex-wrap: wrap;
    }
    .nav-tab {
        font-size: 0.9rem;
        padding: 8px 6px;
        flex-grow: 1;
        text-align: center;
    }
    .btn.export-btn {
        margin-left: 0;
        width: auto;
        justify-content: center;
    }
    .month-tabs-container {
        padding-bottom: 15px;
    }
    .month-tab {
        font-size: 0.8rem;
        padding: 4px 5px;
    }
    .cards-container {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
    }
    .card-label, .card-value {
        font-size: 0.9rem;
    }
    .card-value strong {
        font-size: 1rem;
    }
    .modal {
        padding: 20px;
    }
    .modal h2 {
        font-size: 1.3rem;
        margin-bottom: 15px;
    }
    .modal label {
        font-size: 0.9rem;
    }
    .modal input, .modal select, .modal textarea {
        font-size: 0.9rem;
        padding: 8px;
    }
    .modal .row {
        flex-direction: column;
        gap: 0;
    }
    .actions {
        margin-top: 20px;
    }
    .btn {
        padding: 8px 15px;
        font-size: 0.9rem;
    }
}
@media (max-width: 400px) {
    .login-container {
        padding: 20px;
    }
    h1 {
        font-size: 1.6rem;
    }
    .clocks-container {
        gap: 10px;
        padding-top: 5px;
        justify-content: space-between;
    }
    .clock-wrapper {
        min-width: unset;
    }
    .digital-time {
        font-size: 1.1rem;
        min-width: 80px;
    }
    .fab {
        width: 40px;
        height: 40px;
        right: 15px;
        bottom: 15px;
    }
    .fab:hover {
        width: 160px;
        padding-left: 18px;
        padding-right: 18px;
    }
    .toast {
        font-size: 0.9rem;
        padding: 10px 15px;
    }
    #toastContainer {
        min-width: unset;
        max-width: 95%;
    }
    .summary-cards {
        grid-template-columns: 1fr;
    }
}
@media (min-width: 1920px) {
    .container {
        max-width: 1600px;
        padding: 40px;
    }
    .nav-container-wrapper {
        max-width: 1600px;
    }
    h1 {
        font-size: 2.8rem;
    }
    .digital-time {
        font-size: 1.6rem;
    }
    .nav-tab {
        font-size: 1.2rem;
    }
    .summary-card p {
        font-size: 1.8rem;
    }
}
</style>
</head>
<body>
    <div id="global-loader">
        <div class="data-spinner"></div>
    </div>

    <div class="login-container" id="login-container" style="display: none;">
        <h1><i class="fas fa-lock"></i> Secure Login</h1>
        <form id="loginForm">
            <div class="input-group">
                <label for="email">Email</label>
                <input type="email" id="email" required>
            </div>
            <div class="input-group">
                <label for="password">Password</label>
                <input type="password" id="password" required>
            </div>
            <center><button type="submit" class="btn login">Login <i class="fas fa-sign-in-alt"></i></button></center>
        </form>
    </div>

    <div id="app-container" style="display: none;">
        <div class="clocks-container" role="region" aria-label="US timezones live clocks">
            <div class="clock-wrapper"><div class="clock-label">Pacific Time</div><div class="digital-time" id="digital-PST"></div></div>
            <div class="clock-wrapper"><div class="clock-label">Mountain Time</div><div class="digital-time" id="digital-MST"></div></div>
            <div class="clock-wrapper"><div class="clock-label">Central Time</div><div class="digital-time" id="digital-CST"></div></div>
            <div class="clock-wrapper"><div class="clock-label">Eastern Time</div><div class="digital-time" id="digital-EST"></div></div>
        </div>

        <nav role="navigation">
            <div class="nav-container-wrapper">
                <div class="nav-tabs">
                    <a id="tab-accounts" class="nav-tab active" data-target="accounts-view"><i class="fas fa-users"></i> Accounts</a>
                    <a id="tab-sales" class="nav-tab" data-target="sales-view"><i class="fas fa-chart-line"></i> Sales</a>
                </div>
                <div class="auth-actions" id="auth-actions" style="display: none;">
                    <button id="changePasswordBtn" class="btn nav-action-btn"><i class="fas fa-key"></i> Change Password</button>
                    <button id="logoutBtn" class="btn nav-action-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
		    </div>
        </nav>

        <main class="container" id="accounts-view" role="main">
            <div class="header-controls">
                <div class="search-container">
                    <i class="fas fa-search search-icon" aria-hidden="true"></i>
                    <input id="searchInput" placeholder="Search accounts..." aria-label="Search clients" />
                </div>
                <div class="results-count" id="resultsCount">0 Accounts</div>
                <button id="exportAccountsBtn" class="btn export-btn" title="Export current accounts data to CSV">
                    <i class="fas fa-file-export"></i> Export
                </button>
            </div>
            
            <div class="month-tabs-container" id="accountsMonthTabsContainer" role="tablist" aria-label="Filter accounts by month">
                <a class="month-tab active" data-month="All" role="tab" aria-selected="true" tabindex="0">All</a>
            </div>
            <div class="table-container">
                <div id="tableLoadingOverlay" class="data-loading-overlay">
                    <div class="data-spinner"></div>
                </div>

                <table id="accountsTable" role="grid" aria-live="polite">
                    <thead>
                        <tr>
                            <th data-sort="name" tabindex="0" aria-sort="none">Client Name <i class="fas fa-sort sort-icon"></i></th>
                            <th data-sort="email" tabindex="0" aria-sort="none">Email <i class="fas fa-sort sort-icon"></i></th>
                            <th data-sort="phone" tabindex="0" aria-sort="none">Phone <i class="fas fa-sort sort-icon"></i></th>
                            <th data-sort="type" tabindex="0" aria-sort="none">Project Type <i class="fas fa-sort sort-icon"></i></th>
                            <th data-sort="dateAdded" tabindex="0" aria-sort="descending">Date Added <i class="fas fa-sort-down sort-icon"></i></th>
                            <th data-sort="timezone" tabindex="0" aria-sort="none">Timezone <i class="fas fa-sort sort-icon"></i></th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td class="no-data" colspan="7">Loading client data...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="cards-container" id="accountsCardsContainer">
                <div id="cardsLoadingOverlay" class="data-loading-overlay">
                    <div class="data-spinner"></div>
                </div>
            </div>
        </main>

        <main class="container" id="sales-view" role="main" style="display:none;">
            <div class="summary-cards" id="salesSummary">
                <div class="summary-card warning"> 
                    <h4>Gross Sales</h4>
                    <p class="warning" id="totalGross">$0.00</p>
                </div>
                <div class="summary-card danger"> 
                    <h4>Chargebacks</h4>
                    <p class="danger" id="totalChargebacks">$0.00</p>
                </div>
                <div class="summary-card success">
                    <h4>Net Sales</h4>
                    <p class="success" id="totalNet">$0.00</p>
                </div>
            </div>

            <div class="header-controls">
                <div class="search-container">
                    <i class="fas fa-search search-icon" aria-hidden="true"></i>
                    <input id="salesSearchInput" placeholder="Search sales..." aria-label="Search sales" />
                </div>
                <div class="results-count" id="salesResultsCount">0 Sales</div>
                 <button id="exportSalesBtn" class="btn export-btn" title="Export current sales data to CSV">
                    <i class="fas fa-file-export"></i> Export
                </button>
            </div>
            
            <div class="month-tabs-container" id="salesMonthTabsContainer" role="tablist" aria-label="Filter sales by month">
                <a class="month-tab active" data-month="All" role="tab" aria-selected="true" tabindex="0">All</a>
            </div>

            <div class="table-container">
                <div id="salesTableLoadingOverlay" class="data-loading-overlay">
                    <div class="data-spinner"></div>
                </div>
                <table id="salesTable" role="grid" aria-live="polite">
                    <thead>
                        <tr>
                            <th data-sort="clientName" tabindex="0" aria-sort="none">Client Name <i class="fas fa-sort sort-icon"></i></th>
                            <th data-sort="description" tabindex="0" aria-sort="none">Description <i class="fas fa-sort sort-icon"></i></th>
                            <th data-sort="amount" tabindex="0" aria-sort="none">Amount <i class="fas fa-sort sort-icon"></i></th>
                            <th data-sort="status" tabindex="0" aria-sort="none">Status <i class="fas fa-sort sort-icon"></i></th>
                            <th data-sort="date" tabindex="0" aria-sort="descending">Sale Date <i class="fas fa-sort-down sort-icon"></i></th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td class="no-data" colspan="6">Loading sales data...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="cards-container" id="salesCardsContainer">
                <div id="salesCardsLoadingOverlay" class="data-loading-overlay">
                    <div class="data-spinner"></div>
                </div>
            </div>
        </main>

        <button id="fabBtn" class="fab" data-type="account" aria-label="Add account">
            <i class="fas fa-plus" aria-hidden="true"></i> 
            <span class="fab-text" id="fabBtnText">Add Account</span>
        </button>

        <div class="modal-overlay" id="accountModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div class="modal" role="document">
                <h2 id="modalTitle">Add Account</h2>
                <form id="accountForm" autocomplete="off">
                    <label for="accountName">Client Name*</label>
                    <input id="accountName" name="accountName" required />

                    <label for="accountEmail">Email*</label>
                    <input id="accountEmail" name="accountEmail" type="email" required />

                    <label for="accountPhone">Phone (US/CA)*</label>
                    <input id="accountPhone" name="accountPhone" maxlength="14" placeholder="(555) 555-5555" required />
                    
                    <div class="row">
                        <div>
                            <label for="accountType">Project Type*</label>
                            <select id="accountType" name="accountType" required>
                                <option value="" disabled selected>Select project type</option>
                                <option>Web Design</option><option>Logo Design</option><option>App Development</option>
                                <option>Branding</option><option>SEO</option>
                            </select>
                        </div>
                        <div>
                            <label for="dateAdded">Date Added*</label>
                            <input id="dateAdded" name="dateAdded" type="date" onclick="this.showPicker()" required />
                        </div>
                    </div>

                    <div class="actions">
                        <button type="submit" class="btn save" id="saveAccountBtn"><i class="fas fa-save"></i> <span id="saveAccountBtnText">Save</span></button>
                        <button type="button" class="btn cancel" id="cancelAccountBtn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="modal-overlay" id="salesModal" role="dialog" aria-modal="true" aria-labelledby="salesModalTitle">
            <div class="modal sales-modal" role="document">
                <h2 id="salesModalTitle">Add New Sale</h2>
                <form id="salesForm" autocomplete="off">
                    <label for="saleClientId">Client Account*</label>
                    <select id="saleClientId" name="saleClientId" required>
                        <option value="" disabled selected>Select client account</option>
                    </select>

                    <label for="saleDescription">Sale Description*</label>
                    <textarea id="saleDescription" name="saleDescription" rows="2" required></textarea>

                    <div class="row">
                        <div>
                            <label for="saleAmount">Amount ($)*</label>
                            <input id="saleAmount" name="saleAmount" type="number" step="0.01" min="0" required />
                        </div>
                        <div>
                            <label for="saleDate">Sale Date*</label>
                            <input id="saleDate" name="saleDate" type="date" onclick="this.showPicker()" required />
                        </div>
                    </div>
                    
                    <label for="saleStatus">Payment Status*</label>
                    <select id="saleStatus" name="saleStatus" required>
                        <option value="Paid" selected>Paid</option>
                        <option value="Chargeback">Chargeback</option>
                    </select>

                    <div class="actions">
                        <button type="submit" class="btn save" id="saveSaleBtn"><i class="fas fa-hand-holding-usd"></i> <span id="saveSaleBtnText">Save Sale</span></button>
                        <button type="button" class="btn cancel" id="cancelSaleBtn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="modal-overlay" id="viewSalesByAccountModal" role="dialog" aria-modal="true" aria-labelledby="viewSalesModalTitle">
            <div class="modal sales-modal sales-list-modal" role="document">
                <h2 id="viewSalesModalTitle">Sales for Account</h2>
                <div id="accountSalesListBody">
                    <div class="table-container" style="min-height: 100px; margin-top: 10px; border: 0;">
                        <table style="min-width: unset; background: transparent;">
                            <thead>
                                <tr>
                                    <th style="width: 20%;">Date</th>
                                    <th style="width: 30%; padding-left:0;">Description</th>
                                    <th style="width: 25%;">Amount</th>
                                    <th style="width: 25%;">Status</th>                        
                                </tr>
                            </thead>
                            <tbody id="accountSalesTableBody">
                                <tr><td colspan="4" class="no-data">Loading sales data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="actions" style="margin-top: 20px;">
                    <button type="button" class="btn cancel" id="closeViewSalesBtn">Close</button>
                </div>
            </div>
        </div>

        <div class="modal-overlay" id="changePasswordModal" role="dialog" aria-modal="true" aria-labelledby="changePasswordModalTitle">
            <div class="modal" role="document">
                <h2 id="changePasswordModalTitle">Change Password</h2>
                <form id="changePasswordForm" autocomplete="off">
                    <label for="currentPassword">Current Password*</label>
                    <input id="currentPassword" name="currentPassword" type="password" required />

                    <label for="newPassword">New Password*</label>
                    <input id="newPassword" name="newPassword" type="password" required />

                    <label for="confirmPassword">Confirm New Password*</label>
                    <input id="confirmPassword" name="confirmPassword" type="password" required />
                    
                    <div class="actions">
                        <button type="submit" class="btn save" id="updatePasswordBtn"><i class="fas fa-key"></i> Update Password</button>
                        <button type="button" class="btn cancel" id="cancelPasswordBtn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

    </div>
    <div id="toastContainer" aria-live="polite" aria-atomic="true"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, setDoc, deleteDoc, query, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    // 1. Configuration and Initialization
    const firebaseConfig = {
        apiKey: "AIzaSyC0PnNTeQUuisoC0kPcrYjA1s9nHUBo4sc",
        authDomain: "my-accounts-9dbbf.firebaseapp.com",
        projectId: "my-accounts-9dbbf",
        storageBucket: "my-accounts-9dbbf.firebasestorage.app",
        messagingSenderId: "543731220098",
        appId: "1:543731220098:web:2421e3894083fc9259fe9b",
        measurementId: "G-T8XF8QH0DK"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const areaCodeToTZ={201:"EST",202:"EST",203:"EST",205:"CST",206:"PST",207:"EST",208:"MST",209:"PST",210:"CST",212:"EST",213:"PST",214:"CST",215:"EST",216:"EST",217:"CST",218:"CST",219:"CST",224:"CST",225:"CST",228:"CST",229:"EST",231:"EST",234:"EST",239:"EST",240:"EST",248:"EST",251:"CST",252:"EST",253:"PST",254:"CST",256:"CST",260:"EST",262:"CST",267:"EST",269:"EST",270:"CST",272:"EST",274:"CST",276:"EST",281:"CST",301:"EST",302:"EST",303:"MST",304:"EST",305:"EST",307:"MST",308:"CST",309:"CST",310:"PST",312:"CST",313:"EST",314:"CST",315:"EST",316:"CST",317:"EST",318:"CST",319:"CST",320:"CST",321:"EST",323:"PST",325:"CST",330:"EST",331:"CST",334:"CST",336:"EST",337:"CST",339:"EST",346:"CST",347:"EST",351:"EST",352:"EST",360:"PST",361:"CST",386:"EST",401:"EST",402:"CST",404:"EST",405:"CST",406:"MST",407:"EST",408:"PST",409:"CST",410:"EST",412:"EST",413:"EST",414:"CST",415:"PST",417:"CST",419:"EST",423:"EST",424:"PST",425:"PST",430:"CST",432:"CST",434:"EST",435:"MST",440:"EST",442:"PST",443:"EST",458:"PST",470:"EST",475:"EST",478:"EST",479:"CST",480:"MST",484:"EST",501:"CST",502:"EST",503:"PST",504:"CST",505:"MST",507:"CST",508:"EST",509:"PST",510:"PST",512:"CST",513:"EST",515:"CST",516:"EST",517:"EST",518:"EST",520:"MST",530:"PST",531:"CST",534:"CST",540:"EST",541:"PST",551:"EST",559:"PST",561:"EST",562:"PST",563:"CST",567:"EST",570:"EST",571:"EST",573:"CST",574:"CST",575:"MST",580:"CST",585:"EST",601:"CST",602:"MST",603:"EST",605:"CST",606:"EST",607:"EST",608:"CST",609:"EST",610:"EST",612:"CST",614:"EST",615:"CST",616:"EST",617:"EST",618:"CST",619:"PST",620:"CST",623:"MST",626:"PST",628:"PST",629:"CST",630:"CST",631:"EST",636:"CST",641:"CST",646:"EST",650:"PST",651:"CST",657:"PST",660:"CST",661:"PST",662:"CST",667:"EST",669:"PST",678:"EST",682:"CST",701:"CST",702:"PST",703:"EST",704:"EST",706:"EST",707:"PST",708:"CST",712:"CST",713:"CST",714:"PST",715:"CST",716:"EST",717:"EST",718:"EST",719:"MST",720:"MST",724:"EST",727:"EST",731:"CST",732:"EST",734:"EST",737:"CST",740:"EST",754:"EST",757:"EST",760:"PST",762:"EST",763:"CST",765:"EST",769:"CST",770:"EST",772:"EST",773:"CST",774:"EST",775:"PST",779:"CST",781:"EST",785:"CST",786:"EST",801:"MST",802:"EST",803:"EST",804:"EST",805:"PST",806:"CST",808:"HST",810:"EST",812:"EST",813:"EST",814:"EST",815:"CST",816:"CST",817:"CST",818:"PST",828:"EST",831:"PST",832:"CST",843:"EST",845:"EST",847:"CST",848:"EST",850:"EST",854:"EST",856:"EST",857:"EST",858:"PST",859:"EST",860:"EST",862:"EST",863:"EST",864:"EST",865:"EST",870:"CST",872:"CST",901:"CST",903:"CST",904:"EST",906:"EST",907:"AKST",908:"EST",909:"PST",910:"EST",912:"EST",913:"CST",914:"EST",915:"MST",916:"PST",917:"EST",918:"CST",919:"EST",920:"CST",925:"PST",928:"MST",931:"CST",934:"EST",936:"CST",937:"EST",938:"CST",940:"CST",941:"EST",947:"EST",949:"PST",951:"PST",952:"CST",954:"EST",956:"CST",959:"EST",970:"MST",971:"PST",972:"CST",973:"EST",976:"CST",978:"EST",979:"CST",980:"EST",984:"EST",985:"CST",989:"EST",403:"MST",780:"MST",587:"MST",604:"PST",778:"PST",236:"PST",204:"CST",431:"CST",506:"AST",428:"AST",709:"NST",902:"AST",782:"AST",416:"EST",647:"EST",437:"EST",905:"EST",289:"EST",365:"EST",613:"EST",343:"EST",519:"EST",226:"EST",548:"EST",514:"EST",438:"EST",418:"EST",581:"EST",819:"EST",873:"EST",306:"CST",639:"CST"};
    const timezoneMap = {
        'PST': 'America/Los_Angeles',
        'MST': 'America/Denver',
        'CST': 'America/Chicago',
        'EST': 'America/New_York'
    };

    // 2. DOM Elements
    const globalLoader = document.getElementById('global-loader');
    const loginContainer = document.getElementById('login-container');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('loginForm');
    const authActions = document.getElementById('auth-actions');
    const logoutBtn = document.getElementById('logoutBtn');
    const changePasswordBtn = document.getElementById('changePasswordBtn');

    const accountModal = document.getElementById('accountModal');
    const cancelAccountBtn = document.getElementById('cancelAccountBtn');
    const accountForm = document.getElementById('accountForm');
    const accountsTableBody = document.querySelector('#accountsTable tbody');
    const accountsCardsContainer = document.getElementById('accountsCardsContainer');
    const searchInput = document.getElementById('searchInput');
    const dateAddedInput = document.getElementById('dateAdded');
    const resultsCount = document.getElementById('resultsCount');
    const tableLoadingOverlay = document.getElementById('tableLoadingOverlay');
    const cardsLoadingOverlay = document.getElementById('cardsLoadingOverlay');
    const accountsMonthTabsContainer = document.getElementById('accountsMonthTabsContainer');
    
    const salesModal = document.getElementById('salesModal');
    const cancelSaleBtn = document.getElementById('cancelSaleBtn');
    const salesForm = document.getElementById('salesForm');
    const salesTableBody = document.querySelector('#salesTable tbody');
    const salesCardsContainer = document.getElementById('salesCardsContainer');
    const salesSearchInput = document.getElementById('salesSearchInput');
    const salesResultsCount = document.getElementById('salesResultsCount');
    const saleClientIdSelect = document.getElementById('saleClientId');
    const salesTableLoadingOverlay = document.getElementById('salesTableLoadingOverlay');
    const salesCardsLoadingOverlay = document.getElementById('salesCardsLoadingOverlay');
    const totalGrossDisplay = document.getElementById('totalGross');
    const totalChargebacksDisplay = document.getElementById('totalChargebacks');
    const totalNetDisplay = document.getElementById('totalNet');
    const salesMonthTabsContainer = document.getElementById('salesMonthTabsContainer');

    const viewSalesByAccountModal = document.getElementById('viewSalesByAccountModal');
    const viewSalesModalTitle = document.getElementById('viewSalesModalTitle');
    const accountSalesTableBody = document.getElementById('accountSalesTableBody');
    const closeViewSalesBtn = document.getElementById('closeViewSalesBtn');

    const changePasswordModal = document.getElementById('changePasswordModal');
    const changePasswordForm = document.getElementById('changePasswordForm');
    const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');

    const fabBtn = document.getElementById('fabBtn');
    const fabBtnText = document.getElementById('fabBtnText');
    const navTabs = document.querySelectorAll('.nav-tab');
    const views = {
        'accounts-view': document.getElementById('accounts-view'),
        'sales-view': document.getElementById('sales-view')
    };
    const toastContainer = document.getElementById('toastContainer');
    const exportAccountsBtn = document.getElementById('exportAccountsBtn');
    const exportSalesBtn = document.getElementById('exportSalesBtn');

    // 3. Global State
    let accounts = [];
    let sales = [];
    let editAccountId = null;
    let editSaleId = null;
    let currentView = 'accounts-view';
    let accountSort = { column: 'dateAdded', direction: -1 };
    let salesSort = { column: 'date', direction: -1 };
    let currentAccountMonthFilter = 'All'; 
    let currentSalesMonthFilter = 'All';
    let unsubscribeAccounts = null;
    let unsubscribeSales = null;

    // 4. Utility Functions

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        const icon = type === 'success' ? 'fa-check-circle' : (type === 'danger' ? 'fa-exclamation-triangle' : 'fa-info-circle');
        toast.innerHTML = `<i class="fas ${icon}"></i> <span>${message}</span>`;
        toastContainer.appendChild(toast);
        setTimeout(() => {
            toast.remove();
        }, 4000);
    }

    function getAccountTimezone(phone) {
        if (!phone) return 'N/A';
        const cleaned = phone.replace(/\D/g, '');
        const areaCode = cleaned.substring(0, 3);
        return areaCodeToTZ[areaCode] || 'Other/Unknown'; 
    }

    function sortData(data, column, direction) {
        const factor = direction === 1 ? 1 : -1;
        return data.sort((a, b) => {
            let valA = a[column];
            let valB = b[column];
            if (column === 'amount') {
                valA = parseFloat(valA);
                valB = parseFloat(valB);
                return (valA - valB) * factor;
            }
            if (column === 'dateAdded' || column === 'date') {
                valA = moment(valA).valueOf();
                valB = moment(valB).valueOf();
            }
            if (valA < valB) return -1 * factor;
            if (valA > valB) return 1 * factor;
            return 0;
        });
    }

    function formatCurrency(amount) {
        amount = parseFloat(amount);
        const noDecimals = amount % 1 === 0;
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: noDecimals ? 0 : 2,
            maximumFractionDigits: noDecimals ? 0 : 2
        }).format(amount);
    }

    function updateSortIcons(tableId, sortState) {
        document.querySelectorAll(`#${tableId} th`).forEach(th => {
            const sortColumn = th.getAttribute('data-sort');
            const icon = th.querySelector('.sort-icon');
            if (icon) {
                icon.className = 'fas sort-icon';
                if (sortColumn === sortState.column) {
                    icon.classList.add(sortState.direction === 1 ? 'fa-sort-up' : 'fa-sort-down');
                } else if (sortColumn) {
                    icon.classList.add('fa-sort');
                }
            }
        });
    }

    function handleSort(tableId, sortState, data, renderFunction) {
        return function (event) {
            const column = event.currentTarget.getAttribute('data-sort');
            if (!column) return;
            const liveData = tableId === 'accountsTable' ? accounts : sales;
            sortState.direction = (sortState.column === column) ? sortState.direction * -1 : 1;
            sortState.column = column;
            renderFunction(liveData);
            updateSortIcons(tableId, sortState);
        };
    }

    function filterAccounts(data) {
        const searchTerm = searchInput.value.toLowerCase();
        let filtered = data.filter(account =>
            account.name.toLowerCase().includes(searchTerm) ||
            account.email.toLowerCase().includes(searchTerm) ||
            account.phone.includes(searchTerm) ||
            account.type.toLowerCase().includes(searchTerm)
        );
        if (currentAccountMonthFilter !== 'All') {
            const [year, month] = currentAccountMonthFilter.split('-');
            const momentMonth = parseInt(month) - 1; 
            const momentYear = parseInt(year);
            filtered = filtered.filter(account => {
                const date = moment(account.dateAdded);
                return date.year() === momentYear && date.month() === momentMonth;
            });
        }
        return filtered;
    }

    function filterSales(data) {
        const searchTerm = salesSearchInput.value.toLowerCase();
        let filtered = data.filter(sale =>
            (sale.clientName && sale.clientName.toLowerCase().includes(searchTerm)) ||
            sale.description.toLowerCase().includes(searchTerm) ||
            sale.status.toLowerCase().includes(searchTerm)
        );
        if (currentSalesMonthFilter !== 'All') {
            const [year, month] = currentSalesMonthFilter.split('-');
            const momentMonth = parseInt(month) - 1; 
            const momentYear = parseInt(year);
            filtered = filtered.filter(sale => {
                const date = moment(sale.date);
                return date.year() === momentYear && date.month() === momentMonth;
            });
        }
        return filtered;
    }

    function openModal(modalElement) {
        modalElement.style.display = 'flex';
        setTimeout(() => modalElement.classList.add('show'), 10);
    }

    function closeModal(modalElement) {
        modalElement.classList.remove('show');
        setTimeout(() => modalElement.style.display = 'none', 300);
    }

    // 5. Data Handling Functions

    function prepareAccountData(form) {
        const name = form.accountName.value;
        const phone = form.accountPhone.value;
        const timezone = getAccountTimezone(phone);
        return {
            name,
            email: form.accountEmail.value,
            phone,
            type: form.accountType.value,
            dateAdded: form.dateAdded.value,
            timezone,
        };
    }

    function prepareSaleData(form) {
        return {
            clientId: form.saleClientId.value,
            description: form.saleDescription.value,
            amount: parseFloat(form.saleAmount.value).toFixed(2),
            date: form.saleDate.value,
            status: form.saleStatus.value,
        };
    }
    
    async function deleteAccount(id, name) {
        if (!confirm(`Are you sure you want to delete the account for "${name}"? This will also remove associated sales.`)) return;
        NProgress.start();
        try {
            const salesToDelete = sales.filter(s => s.clientId === id);
            for (const sale of salesToDelete) {
                await deleteDoc(doc(db, "sales", sale.id));
            }
            await deleteDoc(doc(db, "accounts", id));
            showToast(`Account "${name}" and ${salesToDelete.length} associated sale(s) deleted successfully.`, 'danger');
        } catch (e) {
            console.error("Error removing document: ", e);
            showToast("Error deleting account.", 'danger');
        } finally {
            NProgress.done();
        }
    }

    async function deleteSale(id, description) {
        if (!confirm(`Are you sure you want to delete the sale "${description}"?`)) return;
        NProgress.start();
        try {
            await deleteDoc(doc(db, "sales", id));
            showToast(`Sale "${description}" deleted successfully.`, 'danger');
        } catch (e) {
            console.error("Error removing sale document: ", e);
            showToast("Error deleting sale.", 'danger');
        } finally {
            NProgress.done();
        }
    }

    function subscribeToData() {
        NProgress.start();
        tableLoadingOverlay.classList.add('active');
        cardsLoadingOverlay.classList.add('active');
        salesTableLoadingOverlay.classList.add('active');
        salesCardsLoadingOverlay.classList.add('active');

        const accountsQuery = query(collection(db, "accounts"));
        unsubscribeAccounts = onSnapshot(accountsQuery, (querySnapshot) => {
            accounts = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAccountsTable(accounts);
            updateSortIcons('accountsTable', accountSort);
            
            if (currentView === 'sales') {
                renderSalesTable(sales);
            }

            tableLoadingOverlay.classList.remove('active');
            cardsLoadingOverlay.classList.remove('active');
            NProgress.done();
        }, (error) => {
            console.error("Error fetching accounts: ", error);
            showToast("Error loading accounts. Check console.", 'danger');
            accountsTableBody.innerHTML = '<tr><td class="no-data" colspan="7">Failed to load client data.</td></tr>';
            tableLoadingOverlay.classList.remove('active');
            cardsLoadingOverlay.classList.remove('active');
            NProgress.done();
        });

        const salesQuery = query(collection(db, "sales"));
        unsubscribeSales = onSnapshot(salesQuery, (querySnapshot) => {
            sales = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            sales.forEach(sale => {
                const client = accounts.find(a => a.id === sale.clientId);
                sale.clientName = client ? client.name : 'Unknown Client';
                sale.status = sale.status || 'Paid'; 
            });
            renderSalesTable(sales);
            updateSortIcons('salesTable', salesSort);
            salesTableLoadingOverlay.classList.remove('active');
            salesCardsLoadingOverlay.classList.remove('active');
        }, (error) => {
            console.error("Error fetching sales: ", error);
            showToast("Error loading sales. Check console.", 'danger');
            salesTableBody.innerHTML = '<tr><td class="no-data" colspan="6">Failed to load sales data.</td></tr>';
            salesTableLoadingOverlay.classList.remove('active');
            salesCardsLoadingOverlay.classList.remove('active');
        });
    }

    function exportToCSV(type) {
        const isAccount = type === 'accounts';
        const data = isAccount ? accounts : sales;
        const filteredData = isAccount ? filterAccounts(data) : filterSales(data);
        if (filteredData.length === 0) {
            showToast('No data to export.', 'warning');
            return;
        }
        const headers = isAccount 
            ? ['Client Name', 'Email', 'Phone', 'Project Type', 'Date Added', 'Timezone']
            : ['Client Name', 'Description', 'Amount', 'Status', 'Sale Date'];
        const rows = filteredData.map(item => {
            if (isAccount) {
                return [
                    `"${item.name.replace(/"/g, '""')}"`,
                    item.email,
                    `'${item.phone}`,
                    item.type,
                    item.dateAdded,
                    item.timezone
                ];
            } else {
                return [
                    `"${item.clientName.replace(/"/g, '""')}"`,
                    `"${item.description.replace(/"/g, '""')}"`,
                    item.amount,
                    item.status,
                    item.date
                ];
            }
        });
        let csvContent = headers.join(',') + '\n' + rows.map(e => e.join(',')).join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        const fileName = `${type.charAt(0).toUpperCase() + type.slice(1)}_Export_${moment().format('DD-MM-YY')}.csv`;
        link.setAttribute("href", url);
        link.setAttribute("download", fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast(`Successfully exported ${filteredData.length} ${type} to CSV.`, 'success');
    }

    // 6. Rendering Functions (Tables, Cards, Tabs, Clocks)

    function updateDigitalClock(tzLabel) {
        const tz = timezoneMap[tzLabel];
        const timeFormat = moment().tz(tz).format('hh:mm A');
        const digitalEl = document.getElementById(`digital-${tzLabel}`);
        if (digitalEl) {
            digitalEl.textContent = timeFormat;
        }
    }

    function updateClocks() {
        Object.keys(timezoneMap).forEach(tz => {
            updateDigitalClock(tz);
        });
    }

    function initClocks() {
        updateClocks();
        setInterval(updateClocks, 1000);
    }

    function renderAccountCard(account) {
        return `
            <div class="account-card" data-id="${account.id}">
                <div class="card-field"><span class="card-label">Client Name</span><span class="card-value"><strong>${account.name}</strong></span></div>
                <div class="card-field"><span class="card-label">Project Type</span><span class="card-value">${account.type}</span></div>
                <div class="card-field"><span class="card-label">Date Added</span><span class="card-value">${moment(account.dateAdded).format('MMM Do, YYYY')}</span></div>
                <div class="card-field"><span class="card-label">Timezone</span><span class="card-value"><span class="badge timezone-badge">${account.timezone}</span></span></div>
                <div class="card-field"><span class="card-label">Email</span><span class="card-value"><a href="mailto:${account.email}">${account.email}</a></span></div>
                <div class="card-field"><span class="card-label">Phone</span><span class="card-value">${account.phone}</span></div>
                <div class="card-actions">
                    <button class="action-btn view-sales" title="View all sales for this account" onclick="viewAccountSales('${account.id}', '${account.name}')"><i class="fas fa-eye"></i> View Sales</button>
                    <button class="action-btn edit" title="Edit account" onclick="editAccount('${account.id}')"><i class="fas fa-edit"></i> Edit</button>
                    <button class="action-btn delete" title="Delete account" onclick="deleteAccount('${account.id}', '${account.name}')"><i class="fas fa-trash-alt"></i> Delete</button>
                </div>
            </div>
        `;
    }

    function renderAccountsTable(data) {
        const sortedData = sortData([...data], accountSort.column, accountSort.direction);
        const filteredData = filterAccounts(sortedData);
        let accountRows;
        let accountCards;
        if (filteredData.length === 0) {
            accountRows = '<tr><td class="no-data" colspan="7">No accounts found matching your criteria.</td></tr>';
            accountCards = '<p class="no-data">No accounts found matching your criteria.</p>';
        } else {
            accountRows = filteredData.map(account => `
                <tr data-id="${account.id}">
                    <td><strong>${account.name}</strong></td>
                    <td>${account.email}</td>
                    <td>${account.phone}</td>
                    <td>${account.type}</td>
                    <td>${moment(account.dateAdded).format('MMM Do, YYYY')}</td>
                    <td><span class="badge timezone-badge">${account.timezone}</span></td>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            <button class="action-btn view-sales" title="View all sales for this account" onclick="viewAccountSales('${account.id}', '${account.name}')"><i class="fas fa-eye"></i></button>
                            <button class="action-btn edit" title="Edit account" onclick="editAccount('${account.id}')"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete" title="Delete account" onclick="deleteAccount('${account.id}', '${account.name}')"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
            accountCards = filteredData.map(account => renderAccountCard(account)).join('');
        }
        accountsTableBody.innerHTML = accountRows;
        accountsCardsContainer.innerHTML = accountCards;
        resultsCount.textContent = `${filteredData.length} Account${filteredData.length !== 1 ? 's' : ''}`;
        updateAccountsMonthTabs(data);
    }

    function updateAccountsMonthTabs(data) {
        const monthMap = {};
        data.forEach(account => {
            const date = moment(account.dateAdded);
            const key = date.format('YYYY-M'); 
            const label = date.format("MMM 'YY");
            if (!monthMap[key]) {
                monthMap[key] = { key, label, count: 0 };
            }
            monthMap[key].count++;
        });
        const sortedMonths = Object.values(monthMap).sort((a, b) => {
            return moment(b.key, 'YYYY-M').valueOf() - moment(a.key, 'YYYY-M').valueOf();
        });
        const allTab = `<a class="month-tab ${currentAccountMonthFilter === 'All' ? 'active' : ''}" data-month="All" role="tab" aria-selected="${currentAccountMonthFilter === 'All'}" tabindex="0">All (${data.length})</a>`;
        const monthTabs = sortedMonths.map(month => {
            const isActive = currentAccountMonthFilter === month.key;
            return `<a class="month-tab ${isActive ? 'active' : ''}" data-month="${month.key}" role="tab" aria-selected="${isActive}" tabindex="0">${month.label} (${month.count})</a>`;
        }).join('');
        accountsMonthTabsContainer.innerHTML = allTab + monthTabs;
    }

    function updateSalesSummary(data) {
        let totalGross = 0;
        let totalChargebacks = 0;
        data.forEach(sale => {
            const amount = parseFloat(sale.amount);
            totalGross += amount;
            if (sale.status === 'Chargeback') {
                totalChargebacks += amount;
            }
        });
        const totalNet = totalGross - totalChargebacks;
        totalGrossDisplay.textContent = formatCurrency(totalGross);
        totalChargebacksDisplay.textContent = formatCurrency(totalChargebacks);
        totalNetDisplay.textContent = formatCurrency(totalNet);
    }

    function renderSaleCard(sale) {
        const amountDisplay = formatCurrency(sale.amount);
        const statusClass = sale.status.toLowerCase();
        const statusBadge = `<span class="badge ${statusClass}">${sale.status}</span>`;
        const dateFormatted = moment(sale.date).format('MMM Do, YYYY');
        return `
            <div class="account-card sales-card" data-id="${sale.id}">
                <div class="card-field"><span class="card-label">Client Name</span><span class="card-value"><strong>${sale.clientName}</strong></span></div>
                <div class="card-field"><span class="card-label">Description</span><span class="card-value">${sale.description}</span></div>
                <div class="card-field"><span class="card-label">Amount</span><span class="card-value" style="color: var(--success); font-weight: 700;">${amountDisplay}</span></div>
                <div class="card-field"><span class="card-label">Status</span><span class="card-value">${statusBadge}</span></div>
                <div class="card-field"><span class="card-label">Sale Date</span><span class="card-value">${dateFormatted}</span></div>
                <div class="card-actions">
                    <button class="action-btn sales-edit" title="Edit sale" onclick="editSale('${sale.id}')"><i class="fas fa-edit"></i> Edit</button>
                    <button class="action-btn delete" title="Delete sale" onclick="deleteSale('${sale.id}', '${sale.clientName} - ${sale.description}')"><i class="fas fa-trash-alt"></i> Delete</button>
                </div>
            </div>
        `;
    }

    function renderSalesTable(data) {
        const sortedData = sortData([...data], salesSort.column, salesSort.direction);
        const filteredData = filterSales(sortedData);
        updateSalesSummary(filteredData);
        let salesRows;
        let salesCards;
        if (filteredData.length === 0) {
            salesRows = '<tr><td class="no-data" colspan="6">No sales found matching your criteria.</td></tr>';
            salesCards = '<p class="no-data">No sales found matching your criteria.</p>';
        } else {
            salesRows = filteredData.map(sale => {
                const amountDisplay = formatCurrency(sale.amount);
                const statusClass = sale.status.toLowerCase();
                const statusBadge = `<span class="badge ${statusClass}">${sale.status}</span>`;
                const dateFormatted = moment(sale.date).format('MMM Do, YYYY');
                return `
                    <tr data-id="${sale.id}">
                        <td><strong>${sale.clientName}</strong></td>
                        <td>${sale.description}</td>
                        <td style="font-weight: 600;">${amountDisplay}</td>
                        <td>${statusBadge}</td>
                        <td>${dateFormatted}</td>
                        <td>
                            <div style="display: flex; gap: 5px;">
                                <button class="action-btn sales-edit" title="Edit sale" onclick="editSale('${sale.id}')"><i class="fas fa-edit"></i></button>
                                <button class="action-btn delete" title="Delete sale" onclick="deleteSale('${sale.id}', '${sale.clientName} - ${sale.description}')"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            salesCards = filteredData.map(sale => renderSaleCard(sale)).join('');
        }
        salesTableBody.innerHTML = salesRows;
        salesCardsContainer.innerHTML = salesCards;
        salesResultsCount.textContent = `${filteredData.length} Sale${filteredData.length !== 1 ? 's' : ''}`;
        updateSalesMonthTabs(data);
    }

    function updateSalesMonthTabs(data) {
        const monthMap = {};
        data.forEach(sale => {
            const date = moment(sale.date);
            const key = date.format('YYYY-M'); 
            const label = date.format("MMM 'YY");
            if (!monthMap[key]) {
                monthMap[key] = { key, label, count: 0 };
            }
            monthMap[key].count++;
        });
        const sortedMonths = Object.values(monthMap).sort((a, b) => {
            return moment(b.key, 'YYYY-M').valueOf() - moment(a.key, 'YYYY-M').valueOf();
        });
        const allTab = `<a class="month-tab ${currentSalesMonthFilter === 'All' ? 'active' : ''}" data-month="All" role="tab" aria-selected="${currentSalesMonthFilter === 'All'}" tabindex="0">All (${data.length})</a>`;
        const monthTabs = sortedMonths.map(month => {
            const isActive = currentSalesMonthFilter === month.key;
            return `<a class="month-tab ${isActive ? 'active' : ''}" data-month="${month.key}" role="tab" aria-selected="${isActive}" tabindex="0">${month.label} (${month.count})</a>`;
        }).join('');
        salesMonthTabsContainer.innerHTML = allTab + monthTabs;
    }

    function renderSalesInAccountModal(salesData) {
        if (salesData.length === 0) {
            return '<tr><td colspan="4" class="no-data">No sales found for this account.</td></tr>';
        }
        return salesData.map(sale => {
            const amountDisplay = formatCurrency(sale.amount);
            const statusClass = sale.status.toLowerCase();
            const statusBadge = `<span class="badge ${statusClass}">${sale.status}</span>`;
            const dateFormatted = moment(sale.date).format('MMM Do, YYYY');
            return `
                <tr>
                    <td>${dateFormatted}</td>
                    <td style="padding-left: 0;">${sale.description}</td>
                    <td style="font-weight: 600;">${amountDisplay}</td>
                    <td>${statusBadge}</td>
                </tr>
            `;
        }).join('');
    }

    // 7. Modal Open Functions

    function openAccountModal(id = null) {
        editAccountId = id;
        accountForm.reset();
        const title = document.getElementById('modalTitle');
        const saveBtnText = document.getElementById('saveAccountBtnText');
        if (!id) {
            dateAddedInput.value = moment().format('YYYY-MM-DD'); 
            title.textContent = 'Add Account';
            saveBtnText.textContent = 'Save';
            document.getElementById('saveAccountBtn').classList.remove('update');
        } else {
            const account = accounts.find(a => a.id === id);
            if (account) {
                title.textContent = 'Edit Account';
                saveBtnText.textContent = 'Update';
                document.getElementById('saveAccountBtn').classList.add('update');
                document.getElementById('accountName').value = account.name;
                document.getElementById('accountEmail').value = account.email;
                document.getElementById('accountPhone').value = account.phone;
                document.getElementById('accountType').value = account.type;
                document.getElementById('dateAdded').value = account.dateAdded;
            }
        }
        openModal(accountModal);
        document.getElementById('accountName').focus();
    }

    function openSalesModal(id = null) {
        if (accounts.length === 0) {
            showToast('Please add an account before adding a sale.', 'warning');
            return;
        }
        editSaleId = id;
        salesForm.reset();
        const title = document.getElementById('salesModalTitle');
        const saveBtnText = document.getElementById('saveSaleBtnText');
        const saleDateInput = document.getElementById('saleDate');
        const saleStatusSelect = document.getElementById('saleStatus');
        saleClientIdSelect.innerHTML = '<option value="" disabled selected>Select client account</option>' + 
            accounts.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        if (!id) {
            title.textContent = 'Add New Sale';
            saveBtnText.textContent = 'Save Sale';
            document.getElementById('saveSaleBtn').classList.remove('update');
            saleDateInput.value = moment().format('YYYY-MM-DD');
            saleStatusSelect.value = 'Paid';
        } else {
            const sale = sales.find(s => s.id === id);
            if (sale) {
                title.textContent = 'Edit Sale';
                saveBtnText.textContent = 'Update Sale';
                document.getElementById('saveSaleBtn').classList.add('update');
                document.getElementById('saleClientId').value = sale.clientId;
                document.getElementById('saleDescription').value = sale.description;
                document.getElementById('saleAmount').value = sale.amount;
                document.getElementById('saleDate').value = sale.date;
                saleStatusSelect.value = sale.status;
            }
        }
        openModal(salesModal);
        document.getElementById('saleClientId').focus();
    }
    
    // 8. Global Window Functions
    window.viewAccountSales = function(accountId, accountName) {
        viewSalesModalTitle.textContent = `All Sales for ${accountName}`;
        const accountSales = sales.filter(sale => sale.clientId === accountId);
        accountSalesTableBody.innerHTML = renderSalesInAccountModal(accountSales);
        openModal(viewSalesByAccountModal);
    }

    window.editAccount = openAccountModal;
    window.deleteAccount = deleteAccount;
    window.editSale = openSalesModal;
    window.deleteSale = deleteSale;

    // 9. Event Listeners

    accountForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        NProgress.start();
        const accountData = prepareAccountData(accountForm);
        try {
            if (editAccountId) {
                await setDoc(doc(db, "accounts", editAccountId), accountData);
                showToast(`Account "${accountData.name}" updated successfully!`, 'success');
            } else {
                await addDoc(collection(db, "accounts"), accountData);
                showToast(`Account "${accountData.name}" added successfully!`, 'success');
            }
            closeModal(accountModal);
        } catch (e) {
            console.error("Error adding/updating document: ", e);
            showToast("Error saving account data. Check console.", 'danger');
        } finally {
            NProgress.done();
        }
    });

    salesForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        NProgress.start();
        const saleData = prepareSaleData(salesForm);
        try {
            if (editSaleId) {
                await setDoc(doc(db, "sales", editSaleId), saleData);
                showToast(`Sale updated successfully!`, 'success');
            } else {
                await addDoc(collection(db, "sales"), saleData);
                showToast(`Sale added successfully!`, 'success');
            }
            closeModal(salesModal);
        } catch (e) {
            console.error("Error adding/updating sale document: ", e);
            showToast("Error saving sale data. Check console.", 'danger');
        } finally {
            NProgress.done();
        }
    });

    cancelAccountBtn.onclick = () => closeModal(accountModal);
    cancelSaleBtn.onclick = () => closeModal(salesModal);
    cancelPasswordBtn.onclick = () => closeModal(changePasswordModal);
    closeViewSalesBtn.onclick = function() {
        closeModal(viewSalesByAccountModal);
        setTimeout(() => {
            accountSalesTableBody.innerHTML = '<tr><td colspan="4" class="no-data">Loading sales data...</td></tr>';
        }, 300);
    }

    searchInput.addEventListener('input', () => renderAccountsTable(accounts));
    salesSearchInput.addEventListener('input', () => renderSalesTable(sales));

    accountsMonthTabsContainer.addEventListener('click', (e) => {
        const target = e.target;
        if (target.classList.contains('month-tab')) {
            document.querySelector('#accounts-view .table-container').classList.add('data-reloading');
            document.querySelector('#accounts-view .cards-container').classList.add('data-reloading');
            
            setTimeout(() => {
                document.querySelectorAll('#accountsMonthTabsContainer .month-tab').forEach(tab => {
                    tab.classList.remove('active');
                    tab.setAttribute('aria-selected', 'false');
                });
                target.classList.add('active');
                target.setAttribute('aria-selected', 'true');
                currentAccountMonthFilter = target.getAttribute('data-month');
                renderAccountsTable(accounts);
                document.querySelector('#accounts-view .table-container').classList.remove('data-reloading');
                document.querySelector('#accounts-view .cards-container').classList.remove('data-reloading');
            }, 200);
        }
    });

    salesMonthTabsContainer.addEventListener('click', (e) => {
        const target = e.target;
        if (target.classList.contains('month-tab')) {
            document.querySelector('#sales-view .table-container').classList.add('data-reloading');
            document.querySelector('#sales-view .cards-container').classList.add('data-reloading');
            
            setTimeout(() => {
                document.querySelectorAll('#salesMonthTabsContainer .month-tab').forEach(tab => {
                    tab.classList.remove('active');
                    tab.setAttribute('aria-selected', 'false');
                });
                target.classList.add('active');
                target.setAttribute('aria-selected', 'true');
                currentSalesMonthFilter = target.getAttribute('data-month'); 
                renderSalesTable(sales);
                document.querySelector('#sales-view .table-container').classList.remove('data-reloading');
                document.querySelector('#sales-view .cards-container').classList.remove('data-reloading');
            }, 200);
        }
    });

    navTabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
            const activeTab = document.querySelector('.nav-tab.active');
            if (activeTab === e.currentTarget) return;

            const targetViewId = e.currentTarget.getAttribute('data-target');
            const activeViewId = activeTab.getAttribute('data-target');

            navTabs.forEach(t => t.classList.remove('active'));
            e.currentTarget.classList.add('active');
            
            const activeView = views[activeViewId];
            const targetView = views[targetViewId];
            
            activeView.classList.add('fade-out');
            
            setTimeout(() => {
                activeView.style.display = 'none';
                activeView.classList.remove('fade-out');
                targetView.style.display = 'block';

                currentView = targetViewId.replace('-view', '');
                fabBtn.classList.toggle('sales', currentView === 'sales');
                fabBtn.setAttribute('data-type', currentView === 'sales' ? 'sales' : 'account');
                fabBtnText.textContent = currentView === 'sales' ? 'Add Sale' : 'Add Account';
                fabBtn.setAttribute('aria-label', currentView === 'sales' ? 'Add sale' : 'Add account');
                
                if (currentView === 'accounts') {
                    renderAccountsTable(accounts);
                    updateSortIcons('accountsTable', accountSort);
                } else {
                    renderSalesTable(sales);
                    updateSortIcons('salesTable', salesSort);
                }
            }, 300);
        });
    });

    fabBtn.addEventListener('click', () => {
        const type = fabBtn.getAttribute('data-type');
        if (type === 'account') {
            openAccountModal();
        } else if (type === 'sales') {
            openSalesModal();
        }
    });

    document.querySelectorAll('#accountsTable thead th').forEach(th => {
        th.addEventListener('click', handleSort('accountsTable', accountSort, accounts, renderAccountsTable));
    });

    document.querySelectorAll('#salesTable thead th').forEach(th => {
        th.addEventListener('click', handleSort('salesTable', salesSort, sales, renderSalesTable));
    });

    document.getElementById('accountPhone').addEventListener('input', (e) => {
        const input = e.target;
        let cleaned = input.value.replace(/\D/g, '');
        let formatted = '';
        if (cleaned.length > 0) {
            formatted += '(' + cleaned.substring(0, 3);
        }
        if (cleaned.length > 3) {
            formatted += ') ' + cleaned.substring(3, 6);
        }
        if (cleaned.length > 6) {
            formatted += '-' + cleaned.substring(6, 10);
        }
        input.value = formatted;
    });

    accountsTableBody.addEventListener('click', (e) => {
        const target = e.target.closest('td');
        if (!target) return;
        const cellIndex = target.cellIndex;
        let textToCopy = target.textContent.trim();
        let label = '';
        if (cellIndex === 0) {
            label = 'Client Name';
        } else if (cellIndex === 1) {
            label = 'Email';
        } else if (cellIndex === 2) {
            label = 'Phone';
            textToCopy = textToCopy.replace(/[\(\) -]/g, ''); 
        } else {
            return;
        }
        if (textToCopy) {
            navigator.clipboard.writeText(textToCopy).then(() => {
                showToast(`${label} copied: ${textToCopy}`, 'info');
            }).catch(err => {
                showToast('Failed to copy text. Please try manually.', 'danger');
                console.error('Could not copy text: ', err);
            });
        }
    });
    
    exportAccountsBtn.addEventListener('click', () => exportToCSV('accounts'));
    exportSalesBtn.addEventListener('click', () => exportToCSV('sales'));

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        NProgress.start();
        const email = loginForm.email.value;
        const password = loginForm.password.value;
        signInWithEmailAndPassword(auth, email, password)
            .then(userCredential => {
                localStorage.setItem('loginTimestamp', Date.now());
                showToast('Login successful!', 'success');
                loginForm.reset();
            })
            .catch(error => {
                console.error("Login failed:", error);
                showToast('Login failed. Please check your credentials.', 'danger');
            })
            .finally(() => {
                NProgress.done();
            });
    });

    logoutBtn.addEventListener('click', () => {
        appContainer.classList.add('logging-out');
        setTimeout(() => {
            localStorage.removeItem('loginTimestamp');
            signOut(auth).then(() => {
                showToast('You have been logged out.', 'info');
            }).catch(error => {
                console.error("Logout failed:", error);
                showToast('Logout failed. Please try again.', 'danger');
            }).finally(() => {
                appContainer.classList.remove('logging-out');
            });
        }, 500);
    });


changePasswordBtn.addEventListener("click", () => {
    changePasswordForm.reset();
    openModal(changePasswordModal);
});

// Handle password update submission
changePasswordForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    NProgress.start();

    const user = auth.currentUser;
    const currentPassword = document.getElementById("currentPassword").value.trim();
    const newPassword = document.getElementById("newPassword").value.trim();
    const confirmPassword = document.getElementById("confirmPassword").value.trim();
    const updateBtn = document.getElementById("updatePasswordBtn");
    const modalBox = changePasswordModal.querySelector(".modal");

    // Lock UI + show spinner
    modalBox.classList.add("processing");
    updateBtn.disabled = true;
    const originalText = updateBtn.innerHTML;
    updateBtn.innerHTML = `<span class="spinner"></span> Updating...`;

    try {
        if (newPassword.length < 6) throw { code: "weak-password" };
        if (newPassword !== confirmPassword) throw { code: "mismatch" };

        const { EmailAuthProvider, reauthenticateWithCredential, updatePassword } =
            await import("https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js");

        const credential = EmailAuthProvider.credential(user.email, currentPassword);
        await reauthenticateWithCredential(user, credential);
        await updatePassword(user, newPassword);

        // ✅ Show success animation
        updateBtn.classList.add("success-check");
        updateBtn.innerHTML = `<i class="fas fa-check"></i> Updated!`;
        showToast("Password updated successfully!", "success");

        // Wait a moment for the user to see it
        await new Promise((res) => setTimeout(res, 1200));

        closeModal(changePasswordModal);
        changePasswordForm.reset();
    } catch (error) {
        console.error("Password update error:", error);
        if (error.code === "auth/wrong-password") {
            showToast("Current password is incorrect.", "danger");
        } else if (error.code === "weak-password") {
            showToast("Password must be at least 6 characters long.", "danger");
        } else if (error.code === "mismatch") {
            showToast("Passwords do not match.", "danger");
        } else {
            showToast("Failed to update password. Try again.", "danger");
        }
    } finally {
        // Unlock UI + reset button
        NProgress.done();
        modalBox.classList.remove("processing");
        setTimeout(() => {
            updateBtn.disabled = false;
            updateBtn.classList.remove("success-check");
            updateBtn.innerHTML = originalText;
        }, 500);
    }
});

    // 10. Initialization and Auth State Handler
    if (dateAddedInput) {
        dateAddedInput.value = moment().format('YYYY-MM-DD');
    }
    const saleDateInput = document.getElementById('saleDate');
    if (saleDateInput) {
        saleDateInput.value = moment().format('YYYY-MM-DD');
    }

    onAuthStateChanged(auth, user => {
        globalLoader.classList.add('hidden');
        if (user) {
            const loginTime = localStorage.getItem('loginTimestamp');
            const NINE_HOURS_IN_MS = 9 * 60 * 60 * 1000;

            if (loginTime && (Date.now() - parseInt(loginTime) > NINE_HOURS_IN_MS)) {
                localStorage.removeItem('loginTimestamp');
                signOut(auth);
                showToast('Your session has expired. Please log in again.', 'info');
                return; 
            }

            loginContainer.style.display = 'none';
            appContainer.style.display = 'block';
            authActions.style.display = 'flex';
            document.title = 'Account Management System | Dashboard';
            initClocks();
            subscribeToData();
        } else {
            localStorage.removeItem('loginTimestamp');
            if (unsubscribeAccounts) unsubscribeAccounts();
            if (unsubscribeSales) unsubscribeSales();
            loginContainer.style.display = 'block';
            appContainer.style.display = 'none';
            authActions.style.display = 'none';
            document.title = 'Account Management System | Login';
            accounts = [];
            sales = [];
            renderAccountsTable([]);
            renderSalesTable([]);
        }
    });
</script></body>
</html>