<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Account Management System | Login</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/9131/9131478.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.43/moment-timezone-with-data.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
:root {
    --primary: #6d28d9;
    --primary-dark: #5b21b6;
    --primary-light: rgba(109, 40, 217, 0.1);
    --primary-text: #ffffff;
    
    --danger: #ef4444;
    --danger-light: rgba(239, 68, 68, 0.1);
    --success: #22c55e;
    --success-light: rgba(34, 197, 94, 0.1);
    --warning: #f59e0b;
    --warning-light: rgba(245, 158, 11, 0.1);
    
    --text-primary: #111827;
    --text-secondary: #4b5563;
    --text-muted: #6b7280;
    --text-inverted: #ffffff;

    --bg-primary: #f8f9fa;
    --bg-secondary: #ffffff;
    --bg-overlay: rgba(0, 0, 0, 0.5);
    
    --border-color: #e5e7eb;
    --border-color-dark: #d1d5db;
    
    --radius: 8px;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -2px rgba(0, 0, 0, 0.07);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
    --transition: all 0.2s ease-in-out;
}

body.dark-mode {
    --primary: #a78bfa;
    --primary-dark: #c4b5fd;
    --primary-light: rgba(167, 139, 250, 0.1);

    --danger: #f87171;
    --danger-light: rgba(248, 113, 113, 0.1);
    --success: #4ade80;
    --success-light: rgba(74, 222, 128, 0.1);
    --warning: #fcd34d;
    --warning-light: rgba(252, 211, 77, 0.1);

    --text-primary: #f3f4f6;
    --text-secondary: #d1d5db;
    --text-muted: #9ca3af;
    --text-inverted: #121212;

    --bg-primary: #121212;
    --bg-secondary: #1e1e1e;
    --bg-overlay: rgba(0, 0, 0, 0.7);

    --border-color: #374151;
    --border-color-dark: #4b5563;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
    font-family: 'Inter', sans-serif;
    line-height: 1.6;
    color: var(--text-primary);
    background-color: var(--bg-primary);
    transition: background-color 0.2s ease, color 0.2s ease;
}

::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-color-dark); border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

/* === Global Loader === */
#global-loader {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: var(--bg-primary);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    gap: 20px;
    transition: opacity 0.3s ease;
}
#global-loader.hidden { opacity: 0; pointer-events: none; }
.loader-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid var(--primary-light);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* === Login Page === */
#login-page {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background-color: var(--bg-primary);
}
.login-container {
    width: 100%;
    max-width: 420px;
    padding: 40px;
    border-radius: var(--radius);
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-lg);
    text-align: center;
}
.login-container h1 {
    font-size: 1.8rem;
    color: var(--primary);
    margin-bottom: 10px;
}
.login-container .login-subtitle {
    font-size: 1rem;
    color: var(--text-secondary);
    margin-bottom: 30px;
}
.input-group {
    margin-bottom: 20px;
    text-align: left;
}
.input-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
    color: var(--text-secondary);
}
.input-group input {
    width: 100%;
    padding: 12px 14px;
    border-radius: var(--radius);
    border: 1px solid var(--border-color-dark);
    font-size: 1rem;
    background: var(--bg-primary);
    color: var(--text-primary);
    transition: var(--transition);
}
.input-group input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-light);
}
.btn {
    padding: 12px 20px;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    text-decoration: none;
    white-space: nowrap;
}
.btn.login {
    width: 100%;
    background: var(--primary);
    color: var(--primary-text);
}
.btn.login:hover { background: var(--primary-dark); }
.btn.save { background: var(--primary); color: var(--primary-text); }
.btn.save:hover:not(:disabled) { background: var(--primary-dark); }
.btn.save.sales { background: var(--success); color: #fff; }
.btn.save.sales:hover:not(:disabled) { background: var(--success-dark); }
.btn.cancel { background: var(--bg-primary); color: var(--text-secondary); border: 1px solid var(--border-color-dark); }
.btn.cancel:hover { background: var(--border-color); }
body.dark-mode .btn.cancel { background: var(--bg-secondary); border-color: var(--border-color-dark); }
body.dark-mode .btn.cancel:hover { background: var(--border-color); }
.btn.save:disabled { opacity: 0.6; cursor: not-allowed; }

/* === App Layout === */
#app-layout {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}
#app-header {
    display: flex;
    align-items: center;
    padding: 0 24px;
    height: 65px;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    position: sticky;
    top: 0;
    z-index: 100;
    gap: 24px;
}
.header-left {
    display: flex;
    align-items: center;
    gap: 12px;
}
.header-left .logo-icon { font-size: 24px; color: var(--primary); }
.header-left h2 { font-size: 1.3rem; font-weight: 600; color: var(--text-primary); }
#burger-toggle {
    display: none;
    background: none;
    border: none;
    font-size: 20px;
    color: var(--text-primary);
    cursor: pointer;
    padding: 8px;
    border-radius: var(--radius);
}
#burger-toggle:hover { background: var(--bg-primary); }
.nav-tabs {
    display: flex;
    gap: 8px;
}
.nav-tab {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border-radius: var(--radius);
    color: var(--text-secondary);
    text-decoration: none;
    font-weight: 500;
    transition: var(--transition);
}
.nav-tab:hover {
    background: var(--bg-primary);
    color: var(--text-primary);
}
.nav-tab.active {
    background: var(--primary-light);
    color: var(--primary);
    font-weight: 600;
}
body.dark-mode .nav-tab.active {
    color: var(--primary-dark);
}
.header-right {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-left: auto;
}
.clocks-container {
    display: flex;
    gap: 20px;
}
.clock-wrapper { text-align: right; }
.clock-label {
    font-weight: 500;
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.digital-time {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
}
.icon-btn {
    background: none;
    border: 1px solid var(--border-color-dark);
    color: var(--text-secondary);
    width: 38px;
    height: 38px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
}
.icon-btn:hover {
    background: var(--bg-primary);
    color: var(--text-primary);
}
.icon-btn.active {
    background: var(--primary-light);
    color: var(--primary);
    border-color: transparent;
}
.btn.nav-action-btn {
    background: var(--bg-primary);
    color: var(--text-secondary);
    border: 1px solid var(--border-color-dark);
    padding: 8px 14px;
    font-size: 0.9rem;
}
.btn.nav-action-btn:hover { background: var(--border-color); }
.btn.logout {
    background: var(--danger-light);
    color: var(--danger);
    border-color: var(--danger-light);
}
.btn.logout:hover { background: var(--danger); color: #fff; border-color: var(--danger); }

/* === Mobile Menu === */
#mobile-menu {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg-primary);
    z-index: 1000;
    padding: 24px;
    display: flex;
    flex-direction: column;
    transform: translateX(-100%);
    transition: transform 0.3s ease-in-out;
}
#mobile-menu.open { transform: translateX(0); }
.mobile-menu-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 20px;
    margin-bottom: 20px;
}
.mobile-menu-header h2 { font-size: 1.3rem; }
#mobile-menu-close {
    font-size: 24px;
    background: none;
    border: none;
    color: var(--text-primary);
    cursor: pointer;
}
.mobile-nav-tabs {
    display: flex;
    flex-direction: column;
    gap: 10px;
    flex-grow: 1;
}
.mobile-nav-tabs .nav-tab {
    font-size: 1.2rem;
    padding: 16px;
}
.mobile-clocks {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 20px;
}
.mobile-clocks .clock-wrapper { text-align: left; }
.mobile-footer-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.mobile-footer-actions .btn { width: 100%; }

/* === Main Content === */
#app-content-wrapper {
    flex-grow: 1;
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
    padding: 32px;
}
main.container {
    opacity: 1;
    transform: translateY(0);
    transition: opacity 0.3s ease, transform 0.3s ease;
}
main.container.fade-out {
    opacity: 0;
    transform: translateY(10px);
    pointer-events: none;
}
h1.view-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 24px;
    color: var(--text-primary);
}

/* === Dashboard === */
.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 24px;
}
.dashboard-filter {
    padding: 10px 14px;
    border-radius: var(--radius);
    border: 1px solid var(--border-color-dark);
    font-size: 1rem;
    background: var(--bg-secondary);
    color: var(--text-primary);
}
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 24px;
}
.stat-card {
    grid-column: span 12;
    background: var(--bg-secondary);
    padding: 24px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
    border-left: 4px solid var(--primary);
}
.stat-card-title {
    font-size: 1rem;
    color: var(--text-secondary);
    margin-bottom: 8px;
    font-weight: 500;
}
.stat-card-value {
    font-size: 2.25rem;
    font-weight: 700;
    line-height: 1.2;
}
.stat-card-value.success { color: var(--success); }
.stat-card-value.warning { color: var(--warning); }
.stat-card-value.danger { color: var(--danger); }
.chart-container {
    grid-column: 1 / -1;
    background: var(--bg-secondary);
    padding: 24px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
    height: 400px;
}
.highlight-container {
    grid-column: span 12;
    display: flex;
    flex-direction: column;
    gap: 24px;
}
.highlight-card {
    background: var(--bg-secondary);
    padding: 24px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
}
.highlight-title {
    font-size: 1.1rem;
    color: var(--primary);
    font-weight: 600;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.highlight-body .label {
    color: var(--text-muted);
    font-size: 0.9rem;
}
.highlight-body .value {
    font-size: 1.3rem;
    font-weight: 600;
}
.highlight-body .amount { color: var(--success); }
@media (min-width: 600px) { .stat-card { grid-column: span 6; } }
@media (min-width: 950px) { .stat-card { grid-column: span 3; } }
@media (min-width: 1200px) {
    .chart-container { grid-column: span 8; }
    .highlight-container { grid-column: span 4; }
}

/* === Accounts & Sales Views === */
.header-controls {
    display: flex;
    flex-direction: column;
    gap: 20px;
    padding: 24px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    margin-bottom: 24px;
    box-shadow: var(--shadow);
}
.controls-row {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: center;
}
.search-container {
    position: relative;
    flex: 1 1 300px;
}
.search-icon {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
}
.search-container input {
    width: 100%;
    padding: 12px 16px 12px 42px;
    border-radius: var(--radius);
    border: 1px solid var(--border-color-dark);
    font-size: 1rem;
    background: var(--bg-primary);
    color: var(--text-primary);
}
.search-container input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-light);
}
.results-count {
    color: var(--text-secondary);
    font-weight: 500;
    white-space: nowrap;
}
.btn.export-btn {
    background: var(--primary-light);
    color: var(--primary);
}
.btn.export-btn:hover {
    background: var(--primary);
    color: var(--primary-text);
}
.month-tabs-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}
.month-tab {
    padding: 8px 12px;
    color: var(--text-secondary);
    text-decoration: none;
    font-weight: 500;
    font-size: 0.9rem;
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    transition: var(--transition);
    cursor: pointer;
    white-space: nowrap;
}
.month-tab:hover {
    background: var(--primary-light);
    color: var(--primary);
    border-color: var(--primary-light);
}
.month-tab.active {
    color: var(--primary-text);
    background: var(--primary);
    border-color: var(--primary);
    font-weight: 600;
}

/* === Responsive Tables === */
.table-wrapper {
    overflow-x: auto;
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    background: var(--bg-secondary);
    box-shadow: var(--shadow);
    min-height: 200px;
}
table {
    width: 100%;
    border-collapse: collapse;
    min-width: 900px;
}
thead th {
    padding: 14px 16px;
    text-align: left;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    background: var(--bg-primary);
    border-bottom: 2px solid var(--border-color);
    white-space: nowrap;
}
thead th:hover { background: var(--border-color); }
tbody td {
    padding: 14px 16px;
    vertical-align: middle;
    border-bottom: 1px solid var(--border-color);
    font-size: 0.95rem;
    color: var(--text-secondary);
    transition: background-color 0.2s ease;
}
tbody td strong { color: var(--text-primary); font-weight: 600; }
tbody tr:hover td { background: var(--bg-primary); }
tbody td:nth-child(1), tbody td:nth-child(2), tbody td:nth-child(3) { cursor: copy; }
.sort-icon {
    margin-left: 6px;
    opacity: 0.7;
    color: var(--primary);
}
.no-data {
    padding: 40px;
    text-align: center;
    color: var(--text-muted);
    font-style: italic;
    font-size: 1rem;
}
.badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 99px;
    font-size: 0.75rem;
    font-weight: 600;
    border: 1px solid transparent;
}
.timezone-badge { background: var(--primary-light); color: var(--primary); }
.badge.paid { background: var(--success-light); color: var(--success); }
.badge.chargeback { background: var(--danger-light); color: var(--danger); }
.action-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 6px;
    border-radius: var(--radius);
    font-size: 1rem;
    color: var(--text-muted);
    transition: var(--transition);
}
.action-btn:hover { background: var(--border-color); }
.action-btn.edit:hover { color: var(--primary); }
.action-btn.delete:hover { color: var(--danger); }
.action-btn.view-sales:hover { color: var(--success); }

@media (max-width: 950px) {
    .table-wrapper {
        border: none;
        background: none;
        box-shadow: none;
        overflow: visible;
    }
    table, thead, tbody, th, td, tr {
        display: block;
    }
    table { min-width: 0; }
    thead { display: none; }
    tr {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        margin-bottom: 16px;
        box-shadow: var(--shadow);
    }
    tbody tr:hover td { background: none; }
    td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px dotted var(--border-color);
        text-align: right;
        white-space: normal;
        word-break: break-word;
    }
    td:last-child { border-bottom: none; }
    td[data-label="Actions"] {
        justify-content: flex-end;
        gap: 10px;
    }
    td::before {
        content: attr(data-label);
        font-weight: 600;
        color: var(--text-primary);
        text-align: left;
        padding-right: 10px;
    }
}

/* === FAB === */
.fab {
    position: fixed;
    right: 24px;
    bottom: 24px;
    z-index: 220;
    background: var(--primary);
    color: var(--primary-text);
    border: 0;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 56px;
    height: 56px;
    box-shadow: var(--shadow-lg);
    cursor: pointer;
    transition: var(--transition);
}
.fab:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
}
.fab i { font-size: 22px; }
.fab.sales { background: var(--success); }

/* === Modals === */
.modal-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: var(--bg-overlay);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
}
.modal-overlay.show {
    opacity: 1;
    display: flex;
}
.modal {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 30px;
    border-radius: var(--radius);
    width: 90%;
    max-width: 500px;
    box-shadow: var(--shadow-lg);
    transform: scale(0.95);
    transition: transform 0.3s ease-in-out;
}
.modal-overlay.show .modal { transform: scale(1); }
.modal.sales-list-modal { max-width: 700px; }
.modal h2 {
    color: var(--primary);
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 15px;
    margin-bottom: 25px;
    font-size: 1.5rem;
    font-weight: 600;
}
.modal.sales-modal h2 { color: var(--success); }
.modal label {
    display: block;
    margin-top: 15px;
    margin-bottom: 6px;
    font-weight: 500;
    color: var(--text-secondary);
}
.modal input, .modal select, .modal textarea {
    width: 100%;
    padding: 10px 12px;
    border-radius: var(--radius);
    background: var(--bg-primary);
    border: 1px solid var(--border-color-dark);
    color: var(--text-primary);
    font-size: 1rem;
    transition: var(--transition);
}
.modal input:focus, .modal select:focus, .modal textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-light);
}
.modal.sales-modal input:focus, .modal.sales-modal select:focus, .modal.sales-modal textarea:focus {
    border-color: var(--success);
    box-shadow: 0 0 0 3px var(--success-light);
}
.modal select {
    -webkit-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor' class='w-5 h-5'%3E%3Cpath fill-rule='evenodd' d='M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z' clip-rule='evenodd' /%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 1.25rem;
    padding-right: 30px;
}
body.dark-mode .modal select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%239ca3af' class='w-5 h-5'%3E%3Cpath fill-rule='evenodd' d='M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z' clip-rule='evenodd' /%3E%3C/svg%3E");
}
.modal select option { background: var(--bg-primary); color: var(--text-primary); }
.modal .row { display: flex; gap: 20px; }
.modal .row > div { flex: 1; }
.actions {
    margin-top: 30px;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

/* === Searchable Select === */
.searchable-select-container { position: relative; }
.suggestions-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color-dark);
    border-top: none;
    border-radius: 0 0 var(--radius) var(--radius);
    z-index: 1050;
    max-height: 150px;
    overflow-y: auto;
    display: none;
    box-shadow: var(--shadow-lg);
}
.suggestion-item {
    padding: 10px 12px;
    cursor: pointer;
    color: var(--text-secondary);
    transition: var(--transition);
}
.suggestion-item:hover {
    background-color: var(--primary-light);
    color: var(--primary);
}

/* === Toast Notifications === */
#toastContainer {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 90%;
    min-width: 300px;
}
.toast {
    background-color: var(--bg-secondary);
    padding: 14px 20px;
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border-color);
    border-left-width: 4px;
    opacity: 0;
    transform: translateX(100%);
    animation: slideInFadeOut 4s ease-in-out forwards;
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 500;
}
@keyframes slideInFadeOut {
    0% { opacity: 0; transform: translateX(100%); }
    10% { opacity: 1; transform: translateX(0); }
    90% { opacity: 1; transform: translateX(0); }
    100% { opacity: 0; transform: translateX(100%); }
}
.toast i { font-size: 1.2rem; }
.toast.success { border-left-color: var(--success); color: var(--success); }
.toast.danger { border-left-color: var(--danger); color: var(--danger); }
.toast.info { border-left-color: var(--primary); color: var(--primary); }
.toast span { color: var(--text-primary); }

/* === Loading Overlays & Skeletons === */
.data-reloading {
    transition: opacity 0.2s ease-in-out;
    opacity: 0.5;
    pointer-events: none;
}
.skeleton {
    opacity: 0.7;
    animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}
@keyframes pulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
}
.skeleton-row td {
    background-color: var(--bg-primary);
    padding: 14px 16px;
    border-bottom: 1px solid var(--border-color);
}
.skeleton-row td > div {
    height: 20px;
    background-color: var(--border-color);
    border-radius: var(--radius);
}
@media (max-width: 950px) {
    .skeleton-row {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        padding: 16px;
    }
    .skeleton-row td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px dotted var(--border-color);
        background: none;
    }
    .skeleton-row td::before {
        content: '';
        display: block;
        width: 30%;
        height: 16px;
        background: var(--border-color);
        border-radius: var(--radius);
    }
    .skeleton-row td div {
        width: 50%;
        height: 16px;
    }
}

/* === Modal Processing / Success === */
.spinner {
    width: 15px;
    height: 15px;
    border: 2px solid rgba(255, 255, 255, 0.5);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    display: inline-block;
}
.modal.processing {
    pointer-events: none;
    opacity: 0.6;
    transition: opacity 0.2s ease;
    position: relative;
}
.modal.processing::after {
    content: "";
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.1);
    z-index: 10;
    border-radius: inherit;
}
.btn.save.success-check {
    background: var(--success);
    color: #fff;
    position: relative;
    pointer-events: none;
}
.success-check i { animation: pop-in 0.4s ease forwards; }
@keyframes pop-in {
    0% { transform: scale(0); opacity: 0; }
    60% { transform: scale(1.3); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
}

/* === Responsive Header === */
@media (max-width: 1200px) {
    .clocks-container { display: none; }
}
@media (max-width: 950px) {
    #app-header .nav-tabs { display: none; }
    #app-header .header-right { margin-left: auto; }
    #app-header .btn.nav-action-btn { display: none; }
    #burger-toggle { display: block; }
    #app-content-wrapper { padding: 24px; }
}
@media (max-width: 600px) {
    #app-content-wrapper { padding: 16px; }
    h1.view-title { font-size: 1.75rem; }
    .dashboard-header { flex-direction: column; align-items: stretch; }
    .header-controls { padding: 16px; }
    .controls-row {
        flex-direction: column;
        align-items: stretch;
    }
    .btn.export-btn, .results-count {
        flex: 1 1 auto;
        justify-content: center;
    }
    .modal { padding: 20px; width: 95%; }
    .modal .row { flex-direction: column; gap: 0; }
    .actions {
        flex-direction: column-reverse;
        gap: 10px;
    }
    .actions .btn { width: 100%; }
    #toastContainer {
        min-width: unset;
        width: 90%;
        left: 50%;
        transform: translateX(-50%);
        right: auto;
    }
}
</style>
</head>
<body>

    <div id="global-loader">
        <div class="loader-spinner"></div>
    </div>

    <div id="login-page" style="display: none;">
        <div class="login-container">
            <h1><i class="fas fa-lock"></i> Welcome</h1>
            <p class="login-subtitle">Please log in to your account</p>
            <form id="loginForm">
                <div class="input-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required>
                </div>
                <div class="input-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn login">Login <i class="fas fa-sign-in-alt"></i></button>
            </form>
        </div>
    </div>

    <div id="app-layout" style="display: none;">
        
        <header id="app-header">
            <button id="burger-toggle"><i class="fas fa-bars"></i></button>
            <div class="header-left">
                <i class="fas fa-chart-pie logo-icon"></i>
                <h2>Zubair Ahmed</h2>
            </div>
            <nav class="nav-tabs">
                <a id="tab-dashboard" class="nav-tab active" data-target="dashboard-view" href="#"><i class="fas fa-chart-line"></i> Dashboard</a>
                <a id="tab-accounts" class="nav-tab" data-target="accounts-view" href="#"><i class="fas fa-users"></i> Accounts</a>
                <a id="tab-sales" class="nav-tab" data-target="sales-view" href="#"><i class="fas fa-dollar-sign"></i> Sales</a>
            </nav>
            <div class="header-right">
                <div class="clocks-container" role="region" aria-label="US timezones live clocks">
                    <div class="clock-wrapper"><div class="clock-label">Pacific</div><div class="digital-time" id="digital-PST"></div></div>
                    <div class="clock-wrapper"><div class="clock-label">Mountain</div><div class="digital-time" id="digital-MST"></div></div>
                    <div class="clock-wrapper"><div class="clock-label">Central</div><div class="digital-time" id="digital-CST"></div></div>
                    <div class="clock-wrapper"><div class="clock-label">Eastern</div><div class="digital-time" id="digital-EST"></div></div>
                </div>
                <button id="themeToggleBtn" class="icon-btn" title="Toggle Theme"><i class="fas fa-moon"></i></button>
                <button id="changePasswordBtn" class="btn nav-action-btn"><i class="fas fa-key"></i> Change Password</button>
                <button id="logoutBtn" class="btn nav-action-btn logout"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </header>

        <div id="mobile-menu">
            <div class="mobile-menu-header">
                <h2>Menu</h2>
                <button id="mobile-menu-close"><i class="fas fa-times"></i></button>
            </div>
            <nav class="mobile-nav-tabs">
                <a class="nav-tab active" data-target="dashboard-view" href="#"><i class="fas fa-chart-line"></i> Dashboard</a>
                <a class="nav-tab" data-target="accounts-view" href="#"><i class="fas fa-users"></i> Accounts</a>
                <a class="nav-tab" data-target="sales-view" href="#"><i class="fas fa-dollar-sign"></i> Sales</a>
            </nav>
            <div class="mobile-clocks">
                <div class="clock-wrapper"><div class="clock-label">Pacific</div><div class="digital-time" id="digital-PST-mobile"></div></div>
                <div class="clock-wrapper"><div class="clock-label">Mountain</div><div class="digital-time" id="digital-MST-mobile"></div></div>
                <div class="clock-wrapper"><div class="clock-label">Central</div><div class="digital-time" id="digital-CST-mobile"></div></div>
                <div class="clock-wrapper"><div class="clock-label">Eastern</div><div class="digital-time" id="digital-EST-mobile"></div></div>
            </div>
            <div class="mobile-footer-actions">
                <button id="changePasswordBtnMobile" class="btn nav-action-btn"><i class="fas fa-key"></i> Change Password</button>
                <button id="logoutBtnMobile" class="btn nav-action-btn logout"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </div>

        <div id="app-content-wrapper">
            
            <main class="container" id="dashboard-view" role="main">
                <div class="dashboard-header">
                    <h1 class="view-title">Performance Overview</h1>
                    <select id="dashboardMonthFilter" class="dashboard-filter"></select>
                </div>
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-card-title">Gross Sales</div>
                        <div class="stat-card-value warning" id="db-gross-sales">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-title">Net Sales</div>
                        <div class="stat-card-value success" id="db-net-sales">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-title">Chargebacks</div>
                        <div class="stat-card-value danger" id="db-chargebacks">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-title">New Accounts</div>
                        <div class="stat-card-value" id="db-total-sales">0</div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="salesChart"></canvas>
                    </div>

                    <div class="highlight-container">
                        <div class="highlight-card">
                            <div class="highlight-title"><i class="fas fa-trophy"></i> Top Client</div>
                            <div class="highlight-body" id="db-top-client">
                                <span class="value">N/A</span>
                            </div>
                        </div>
                        <div class="highlight-card">
                            <div class="highlight-title"><i class="fas fa-star"></i> Highest Single Sale</div>
                            <div class="highlight-body" id="db-highest-sale">
                                <span class="value">N/A</span>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <main class="container" id="accounts-view" role="main" style="display:none;">
                <h1 class="view-title">Accounts</h1>
                <div class="header-controls">
                    <div class="controls-row">
                        <div class="search-container">
                            <i class="fas fa-search search-icon" aria-hidden="true"></i>
                            <input id="searchInput" placeholder="Search accounts by name, email, phone..." aria-label="Search clients" />
                        </div>
                        <div class="results-count" id="resultsCount">0 Accounts</div>
                        <button id="exportAccountsBtn" class="btn export-btn" title="Export current accounts data to CSV">
                            <i class="fas fa-file-export"></i> Export
                        </button>
                    </div>
                    <div class="month-tabs-container" id="accountsMonthTabsContainer" role="tablist" aria-label="Filter accounts by month">
                    </div>
                </div>
                
                <div class="table-wrapper">
                    <table id="accountsTable" role="grid" aria-live="polite">
                        <thead>
                            <tr>
                                <th data-sort="name" tabindex="0" aria-sort="none">Client Name <i class="fas fa-sort sort-icon"></i></th>
                                <th data-sort="email" tabindex="0" aria-sort="none">Email <i class="fas fa-sort sort-icon"></i></th>
                                <th data-sort="phone" tabindex="0" aria-sort="none">Phone <i class="fas fa-sort sort-icon"></i></th>
                                <th data-sort="type" tabindex="0" aria-sort="none">Project Type <i class="fas fa-sort sort-icon"></i></th>
                                <th data-sort="dateAdded" tabindex="0" aria-sort="descending">Date Added <i class="fas fa-sort-down sort-icon"></i></th>
                                <th data-sort="timezone" tabindex="0" aria-sort="none">Timezone <i class="fas fa-sort sort-icon"></i></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="accountsTableBody">
                            <tr class="skeleton-row skeleton"><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td></tr>
                            <tr class="skeleton-row skeleton"><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td></tr>
                            <tr class="skeleton-row skeleton"><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td></tr>
                        </tbody>
                    </table>
                </div>

                </main>

            <main class="container" id="sales-view" role="main" style="display:none;">
                <h1 class="view-title">Sales</h1>
                 <div class="header-controls">
                    <div class="controls-row">
                        <div class="search-container">
                            <i class="fas fa-search search-icon" aria-hidden="true"></i>
                            <input id="salesSearchInput" placeholder="Search sales by client, description..." aria-label="Search sales" />
                        </div>
                        <div class="results-count" id="salesResultsCount">0 Sales</div>
                        <button id="exportSalesBtn" class="btn export-btn" title="Export current sales data to CSV">
                            <i class="fas fa-file-export"></i> Export
                        </button>
                    </div>
                    <div class="month-tabs-container" id="salesMonthTabsContainer" role="tablist" aria-label="Filter sales by month">
                    </div>
                </div>

                <div class="table-wrapper">
                    <table id="salesTable" role="grid" aria-live="polite">
                        <thead>
                            <tr>
                                <th data-sort="clientName" tabindex="0" aria-sort="none">Client Name <i class="fas fa-sort sort-icon"></i></th>
                                <th data-sort="description" tabindex="0" aria-sort="none">Description <i class="fas fa-sort sort-icon"></i></th>
                                <th data-sort="amount" tabindex="0" aria-sort="none">Amount <i class="fas fa-sort sort-icon"></i></th>
                                <th data-sort="status" tabindex="0" aria-sort="none">Status <i class="fas fa-sort sort-icon"></i></th>
                                <th data-sort="date" tabindex="0" aria-sort="descending">Sale Date <i class="fas fa-sort-down sort-icon"></i></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="salesTableBody">
                            <tr class="skeleton-row skeleton"><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td></tr>
                            <tr class="skeleton-row skeleton"><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td></tr>
                            <tr class="skeleton-row skeleton"><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td><td><div></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </main>

        </div>

        <button id="fabBtn" class="fab" data-type="account" aria-label="Add account" style="display: none;">
            <i class="fas fa-plus" aria-hidden="true"></i> 
        </button>

        <div class="modal-overlay" id="accountModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div class="modal" role="document">
                <h2 id="modalTitle">Add Account</h2>
                <form id="accountForm" autocomplete="off">
                    <label for="accountName">Client Name*</label>
                    <input id="accountName" name="accountName" required />

                    <label for="accountEmail">Email*</label>
                    <input id="accountEmail" name="accountEmail" type="email" required />

                    <label for="accountPhone">Phone (US/CA)*</label>
                    <input id="accountPhone" name="accountPhone" maxlength="14" placeholder="(555) 555-5555" required />
                    
                    <label for="accountCategory">Account Type*</label>
                    <select id="accountCategory" name="accountCategory" required>
                        <option value="" disabled selected>Select account type</option>
                        <option value="New">New</option>
                        <option value="Other">Other</option>
                    </select>

                    <div class="row">
                        <div>
                            <label for="accountType">Project Type*</label>
                            <select id="accountType" name="accountType" required>
                                <option value="" disabled selected>Select project type</option>
                                <option>Web Design</option><option>Logo Design</option><option>App Development</option>
                                <option>Branding</option><option>SEO</option>
                            </select>
                        </div>
                        <div>
                            <label for="dateAdded">Date Added*</label>
                            <input id="dateAdded" name="dateAdded" type="date" onclick="this.showPicker()" required />
                        </div>
                    </div>

                    <div class="actions">
                        <button type="button" class="btn cancel" id="cancelAccountBtn">Cancel</button>
                        <button type="submit" class="btn save" id="saveAccountBtn"><i class="fas fa-save"></i> <span id="saveAccountBtnText">Save</span></button>
                    </div>
                </form>
            </div>
        </div>

        <div class="modal-overlay" id="salesModal" role="dialog" aria-modal="true" aria-labelledby="salesModalTitle">
            <div class="modal sales-modal" role="document">
                <h2 id="salesModalTitle">Add New Sale</h2>
                <form id="salesForm" autocomplete="off">
                    <label for="saleClientSearch">Client Account*</label>
                    <div class="searchable-select-container">
                        <input id="saleClientSearch" name="saleClientSearch" placeholder="Type to search clients..." required autocomplete="off" />
                        <input type="hidden" id="saleClientId" name="saleClientId" required />
                        <div id="clientSuggestions" class="suggestions-dropdown"></div>
                    </div>

                    <label for="saleDescription">Sale Description*</label>
                    <textarea id="saleDescription" name="saleDescription" rows="2" required></textarea>

                    <div class="row">
                        <div>
                            <label for="saleAmount">Amount ($)*</label>
                            <input id="saleAmount" name="saleAmount" type="number" step="0.01" min="0" required />
                        </div>
                        <div>
                            <label for="saleDate">Sale Date*</label>
                            <input id="saleDate" name="saleDate" type="date" onclick="this.showPicker()" required />
                        </div>
                    </div>
                    
                    <label for="saleStatus">Payment Status*</label>
                    <select id="saleStatus" name="saleStatus" required>
                        <option value="Paid" selected>Paid</option>
                        <option value="Chargeback">Chargeback</option>
                    </select>

                    <div class="actions">
                        <button type="button" class="btn cancel" id="cancelSaleBtn">Cancel</button>
                        <button type="submit" class="btn save sales" id="saveSaleBtn"><i class="fas fa-hand-holding-usd"></i> <span id="saveSaleBtnText">Save Sale</span></button>
                    </div>
                </form>
            </div>
        </div>

        <div class="modal-overlay" id="viewSalesByAccountModal" role="dialog" aria-modal="true" aria-labelledby="viewSalesModalTitle">
            <div class="modal sales-modal sales-list-modal" role="document">
                <h2 id="viewSalesModalTitle">Sales for Account</h2>
                <div id="accountSalesListBody">
                    <div class="table-wrapper" style="min-height: 100px; margin-top: 10px; border: 0; box-shadow: none;">
                        <table style="min-width: unset; background: transparent;">
                            <thead>
                                <tr>
                                    <th style="width: 20%;">Date</th>
                                    <th style="width: 30%; padding-left:0;">Description</th>
                                    <th style="width: 25%;">Amount</th>
                                    <th style="width: 25%;">Status</th>                        
                                </tr>
                            </thead>
                            <tbody id="accountSalesTableBody">
                                <tr><td colspan="4" class="no-data" data-label="">Loading sales data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="actions" style="margin-top: 20px;">
                    <button type="button" class="btn cancel" id="closeViewSalesBtn">Close</button>
                </div>
            </div>
        </div>

        <div class="modal-overlay" id="changePasswordModal" role="dialog" aria-modal="true" aria-labelledby="changePasswordModalTitle">
            <div class="modal" role="document">
                <h2 id="changePasswordModalTitle">Change Password</h2>
                <form id="changePasswordForm" autocomplete="off">
                    <label for="currentPassword">Current Password*</label>
                    <input id="currentPassword" name="currentPassword" type="password" required />

                    <label for="newPassword">New Password*</label>
                    <input id="newPassword" name="newPassword" type="password" required />

                    <label for="confirmPassword">Confirm New Password*</label>
                    <input id="confirmPassword" name="confirmPassword" type="password" required />
                    
                    <div class="actions">
                        <button type="button" class="btn cancel" id="cancelPasswordBtn">Cancel</button>
                        <button type="submit" class="btn save" id="updatePasswordBtn"><i class="fas fa-key"></i> Update Password</button>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <div id="toastContainer" aria-live="polite" aria-atomic="true"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, setDoc, deleteDoc, query, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    // 1. Configuration and Initialization
    const firebaseConfig = {
        apiKey: "AIzaSyC0PnNTeQUuisoC0kPcrYjA1s9nHUBo4sc",
        authDomain: "my-accounts-9dbbf.firebaseapp.com",
        projectId: "my-accounts-9dbbf",
        storageBucket: "my-accounts-9dbbf.firebasestorage.app",
        messagingSenderId: "543731220098",
        appId: "1:543731220098:web:2421e3894083fc9259fe9b",
        measurementId: "G-T8XF8QH0DK"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const areaCodeToTZ={201:"EST",202:"EST",203:"EST",205:"CST",206:"PST",207:"EST",208:"MST",209:"PST",210:"CST",212:"EST",213:"PST",214:"CST",215:"EST",216:"EST",217:"CST",218:"CST",219:"CST",224:"CST",225:"CST",228:"CST",229:"EST",231:"EST",234:"EST",239:"EST",240:"EST",248:"EST",251:"CST",252:"EST",253:"PST",254:"CST",256:"CST",260:"EST",262:"CST",267:"EST",269:"EST",270:"CST",272:"EST",274:"CST",276:"EST",281:"CST",301:"EST",302:"EST",303:"MST",304:"EST",305:"EST",307:"MST",308:"CST",309:"CST",310:"PST",312:"CST",313:"EST",314:"CST",315:"EST",316:"CST",317:"EST",318:"CST",319:"CST",320:"CST",321:"EST",323:"PST",325:"CST",330:"EST",331:"CST",334:"CST",336:"EST",337:"CST",339:"EST",346:"CST",347:"EST",351:"EST",352:"EST",360:"PST",361:"CST",386:"EST",401:"EST",402:"CST",404:"EST",405:"CST",406:"MST",407:"EST",408:"PST",409:"CST",410:"EST",412:"EST",413:"EST",414:"CST",415:"PST",417:"CST",419:"EST",423:"EST",424:"PST",425:"PST",430:"CST",432:"CST",434:"EST",435:"MST",440:"EST",442:"PST",443:"EST",458:"PST",470:"EST",475:"EST",478:"EST",479:"CST",480:"MST",484:"EST",501:"CST",502:"EST",503:"PST",504:"CST",505:"MST",507:"CST",508:"EST",509:"PST",510:"PST",512:"CST",513:"EST",515:"CST",516:"EST",517:"EST",518:"EST",520:"MST",530:"PST",531:"CST",534:"CST",540:"EST",541:"PST",551:"EST",559:"PST",561:"EST",562:"PST",563:"CST",567:"EST",570:"EST",571:"EST",573:"CST",574:"CST",575:"MST",580:"CST",585:"EST",601:"CST",602:"MST",603:"EST",605:"CST",606:"EST",607:"EST",608:"CST",609:"EST",610:"EST",612:"CST",614:"EST",615:"CST",616:"EST",617:"EST",618:"CST",619:"PST",620:"CST",623:"MST",626:"PST",628:"PST",629:"CST",630:"CST",631:"EST",636:"CST",641:"CST",646:"EST",650:"PST",651:"CST",657:"PST",660:"CST",661:"PST",662:"CST",667:"EST",669:"PST",678:"EST",682:"CST",701:"CST",702:"PST",703:"EST",704:"EST",706:"EST",707:"PST",708:"CST",712:"CST",713:"CST",714:"PST",715:"CST",716:"EST",717:"EST",718:"EST",719:"MST",720:"MST",724:"EST",727:"EST",731:"CST",732:"EST",734:"EST",737:"CST",740:"EST",754:"EST",757:"EST",760:"PST",762:"EST",763:"CST",765:"EST",769:"CST",770:"EST",772:"EST",773:"CST",774:"EST",775:"PST",779:"CST",781:"EST",785:"CST",786:"EST",801:"MST",802:"EST",803:"EST",804:"EST",805:"PST",806:"CST",808:"HST",810:"EST",812:"EST",813:"EST",814:"EST",815:"CST",816:"CST",817:"CST",818:"PST",828:"EST",831:"PST",832:"CST",843:"EST",845:"EST",847:"CST",848:"EST",850:"EST",854:"EST",856:"EST",857:"EST",858:"PST",859:"EST",860:"EST",862:"EST",863:"EST",864:"EST",865:"EST",870:"CST",872:"CST",901:"CST",903:"CST",904:"EST",906:"EST",907:"AKST",908:"EST",909:"PST",910:"EST",912:"EST",913:"CST",914:"EST",915:"MST",916:"PST",917:"EST",918:"CST",919:"EST",920:"CST",925:"PST",928:"MST",931:"CST",934:"EST",936:"CST",937:"EST",938:"CST",940:"CST",941:"EST",947:"EST",949:"PST",951:"PST",952:"CST",954:"EST",956:"CST",959:"EST",970:"MST",971:"PST",972:"CST",973:"EST",976:"CST",978:"EST",979:"CST",980:"EST",984:"EST",985:"CST",989:"EST",403:"MST",780:"MST",587:"MST",604:"PST",778:"PST",236:"PST",204:"CST",431:"CST",506:"AST",428:"AST",709:"NST",902:"AST",782:"AST",416:"EST",647:"EST",437:"EST",905:"EST",289:"EST",365:"EST",613:"EST",343:"EST",519:"EST",226:"EST",548:"EST",514:"EST",438:"EST",418:"EST",581:"EST",819:"EST",873:"EST",306:"CST",639:"CST"};
    const timezoneMap = {
        'PST': 'America/Los_Angeles',
        'MST': 'America/Denver',
        'CST': 'America/Chicago',
        'EST': 'America/New_York'
    };

    // 2. DOM Elements
    const globalLoader = document.getElementById('global-loader');
    const loginPage = document.getElementById('login-page');
    const appLayout = document.getElementById('app-layout');
    const loginForm = document.getElementById('loginForm');
    const logoutBtn = document.getElementById('logoutBtn');
    const changePasswordBtn = document.getElementById('changePasswordBtn');
    const logoutBtnMobile = document.getElementById('logoutBtnMobile');
    const changePasswordBtnMobile = document.getElementById('changePasswordBtnMobile');
    
    // New UI Elements
    const burgerToggle = document.getElementById('burger-toggle');
    const mobileMenu = document.getElementById('mobile-menu');
    const mobileMenuClose = document.getElementById('mobile-menu-close');
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    const allNavTabs = document.querySelectorAll('.nav-tab');

    const accountModal = document.getElementById('accountModal');
    const cancelAccountBtn = document.getElementById('cancelAccountBtn');
    const accountForm = document.getElementById('accountForm');
    const accountsTableBody = document.querySelector('#accountsTable tbody');
    const searchInput = document.getElementById('searchInput');
    const dateAddedInput = document.getElementById('dateAdded');
    const resultsCount = document.getElementById('resultsCount');
    const accountsMonthTabsContainer = document.getElementById('accountsMonthTabsContainer');
    
    const salesModal = document.getElementById('salesModal');
    const cancelSaleBtn = document.getElementById('cancelSaleBtn');
    const salesForm = document.getElementById('salesForm');
    const salesTableBody = document.querySelector('#salesTable tbody');
    const salesSearchInput = document.getElementById('salesSearchInput');
    const salesResultsCount = document.getElementById('salesResultsCount');
    const saleClientSearchInput = document.getElementById('saleClientSearch');
    const saleClientIdInput = document.getElementById('saleClientId');
    const clientSuggestionsContainer = document.getElementById('clientSuggestions');
    const salesMonthTabsContainer = document.getElementById('salesMonthTabsContainer');

    const viewSalesByAccountModal = document.getElementById('viewSalesByAccountModal');
    const viewSalesModalTitle = document.getElementById('viewSalesModalTitle');
    const accountSalesTableBody = document.getElementById('accountSalesTableBody');
    const closeViewSalesBtn = document.getElementById('closeViewSalesBtn');

    const changePasswordModal = document.getElementById('changePasswordModal');
    const changePasswordForm = document.getElementById('changePasswordForm');
    const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');

    const fabBtn = document.getElementById('fabBtn');
    const views = {
        'dashboard-view': document.getElementById('dashboard-view'),
        'accounts-view': document.getElementById('accounts-view'),
        'sales-view': document.getElementById('sales-view')
    };
    const toastContainer = document.getElementById('toastContainer');
    const exportAccountsBtn = document.getElementById('exportAccountsBtn');
    const exportSalesBtn = document.getElementById('exportSalesBtn');

    // Dashboard Elements
    const dashboardMonthFilter = document.getElementById('dashboardMonthFilter');
    const dbGrossSales = document.getElementById('db-gross-sales');
    const dbNetSales = document.getElementById('db-net-sales');
    const dbChargebacks = document.getElementById('db-chargebacks');
    const dbTotalSales = document.getElementById('db-total-sales');
    const dbTopClient = document.getElementById('db-top-client');
    const dbHighestSale = document.getElementById('db-highest-sale');
    const salesChartCanvas = document.getElementById('salesChart').getContext('2d');
    let salesChart = null;

    // 3. Global State
    let accounts = [];
    let sales = [];
    let editAccountId = null;
    let editSaleId = null;
    let currentView = 'dashboard-view';
    let accountSort = { column: 'dateAdded', direction: -1 };
    let salesSort = { column: 'date', direction: -1 };
    let currentAccountMonthFilter = 'All'; 
    let currentSalesMonthFilter = 'All';
    let unsubscribeAccounts = null;
    let unsubscribeSales = null;
    
    // Skeleton HTML
    const skeletonRowHTML = (cols) => `<tr class="skeleton-row skeleton">${Array(cols).fill('<td><div></div></td>').join('')}</tr>`;

    // 4. Utility Functions

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        const icon = type === 'success' ? 'fa-check-circle' : (type === 'danger' ? 'fa-exclamation-triangle' : 'fa-info-circle');
        toast.innerHTML = `<i class="fas ${icon}"></i> <span>${message}</span>`;
        toastContainer.appendChild(toast);
        setTimeout(() => {
            toast.remove();
        }, 4000);
    }

    function getAccountTimezone(phone) {
        if (!phone) return 'N/A';
        const cleaned = phone.replace(/\D/g, '');
        const areaCode = cleaned.substring(0, 3);
        return areaCodeToTZ[areaCode] || 'Other/Unknown'; 
    }

    function sortData(data, column, direction) {
        const factor = direction === 1 ? 1 : -1;
        return data.sort((a, b) => {
            let valA = a[column];
            let valB = b[column];
            if (column === 'amount') {
                valA = parseFloat(valA);
                valB = parseFloat(valB);
                return (valA - valB) * factor;
            }
            if (column === 'dateAdded' || column === 'date') {
                valA = moment(valA).valueOf();
                valB = moment(valB).valueOf();
            }
            if (valA < valB) return -1 * factor;
            if (valA > valB) return 1 * factor;
            return 0;
        });
    }

    function formatCurrency(amount) {
        amount = parseFloat(amount);
        const noDecimals = amount % 1 === 0;
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: noDecimals ? 0 : 2,
            maximumFractionDigits: noDecimals ? 0 : 2
        }).format(amount);
    }

    function updateSortIcons(tableId, sortState) {
        document.querySelectorAll(`#${tableId} th`).forEach(th => {
            const sortColumn = th.getAttribute('data-sort');
            const icon = th.querySelector('.sort-icon');
            if (icon) {
                icon.className = 'fas sort-icon';
                if (sortColumn === sortState.column) {
                    icon.classList.add(sortState.direction === 1 ? 'fa-sort-up' : 'fa-sort-down');
                } else if (sortColumn) {
                    icon.classList.add('fa-sort');
                }
            }
        });
    }

    function handleSort(tableId, sortState, data, renderFunction) {
        return function (event) {
            const column = event.currentTarget.getAttribute('data-sort');
            if (!column) return;
            const liveData = tableId === 'accountsTable' ? accounts : sales;
            sortState.direction = (sortState.column === column) ? sortState.direction * -1 : 1;
            sortState.column = column;
            renderFunction(liveData);
            updateSortIcons(tableId, sortState);
        };
    }

    function filterAccounts(data) {
        const searchTerm = searchInput.value.toLowerCase();

        let filtered = data.filter(account =>
            account.name.toLowerCase().includes(searchTerm) ||
            account.email.toLowerCase().includes(searchTerm) ||
            account.phone.includes(searchTerm) ||
            account.type.toLowerCase().includes(searchTerm)
        );

        if (currentAccountMonthFilter === 'Other') {
            filtered = filtered.filter(account => account.category === 'Other');
        } else {
            filtered = filtered.filter(account => account.category !== 'Other');
            
            if (currentAccountMonthFilter !== 'All') {
                const [year, month] = currentAccountMonthFilter.split('-');
                const momentMonth = parseInt(month) - 1;
                const momentYear = parseInt(year);
                filtered = filtered.filter(account => {
                    const date = moment(account.dateAdded);
                    return date.year() === momentYear && date.month() === momentMonth;
                });
            }
        }
        return filtered;
    }


    function filterSales(data) {
        const searchTerm = salesSearchInput.value.toLowerCase();
        let filtered = data.filter(sale =>
            (sale.clientName && sale.clientName.toLowerCase().includes(searchTerm)) ||
            sale.description.toLowerCase().includes(searchTerm) ||
            sale.status.toLowerCase().includes(searchTerm)
        );
        if (currentSalesMonthFilter !== 'All') {
            const [year, month] = currentSalesMonthFilter.split('-');
            const momentMonth = parseInt(month) - 1; 
            const momentYear = parseInt(year);
            filtered = filtered.filter(sale => {
                const date = moment(sale.date);
                return date.year() === momentYear && date.month() === momentMonth;
            });
        }
        return filtered;
    }

    function openModal(modalElement) {
        modalElement.style.display = 'flex';
        setTimeout(() => modalElement.classList.add('show'), 10);
    }

    function closeModal(modalElement) {
        modalElement.classList.remove('show');
        setTimeout(() => modalElement.style.display = 'none', 300);
    }
    
    function showLoadingSkeletons() {
        accountsTableBody.innerHTML = skeletonRowHTML(7).repeat(5);
        salesTableBody.innerHTML = skeletonRowHTML(6).repeat(5);
    }

    // 5. Data Handling Functions

    function prepareAccountData(form) {
        const name = form.accountName.value;
        const phone = form.accountPhone.value;
        const timezone = getAccountTimezone(phone);
        return {
            name,
            email: form.accountEmail.value,
            phone,
            type: form.accountType.value,
            dateAdded: form.dateAdded.value,
            timezone,
            category: form.accountCategory.value,
        };
    }

    function prepareSaleData(form) {
        return {
            clientId: form.saleClientId.value,
            description: form.saleDescription.value,
            amount: parseFloat(form.saleAmount.value).toFixed(2),
            date: form.saleDate.value,
            status: form.saleStatus.value,
        };
    }
    
    async function deleteAccount(id, name) {
        if (!confirm(`Are you sure you want to delete the account for "${name}"? This will also remove associated sales.`)) return;
        NProgress.start();
        try {
            const salesToDelete = sales.filter(s => s.clientId === id);
            for (const sale of salesToDelete) {
                await deleteDoc(doc(db, "sales", sale.id));
            }
            await deleteDoc(doc(db, "accounts", id));
            showToast(`Account "${name}" and ${salesToDelete.length} associated sale(s) deleted successfully.`, 'danger');
        } catch (e) {
            console.error("Error removing document: ", e);
            showToast("Error deleting account.", 'danger');
        } finally {
            NProgress.done();
        }
    }

    async function deleteSale(id, description) {
        if (!confirm(`Are you sure you want to delete the sale "${description}"?`)) return;
        NProgress.start();
        try {
            await deleteDoc(doc(db, "sales", id));
            showToast(`Sale "${description}" deleted successfully.`, 'danger');
        } catch (e) {
            console.error("Error removing sale document: ", e);
            showToast("Error deleting sale.", 'danger');
        } finally {
            NProgress.done();
        }
    }

    function subscribeToData() {
        NProgress.start();
        showLoadingSkeletons();

        const accountsQuery = query(collection(db, "accounts"));
        unsubscribeAccounts = onSnapshot(accountsQuery, (querySnapshot) => {
            accounts = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAccountsTable(accounts);
            updateSortIcons('accountsTable', accountSort);
            
            if (currentView === 'sales') {
                renderSalesTable(sales);
            }
            if (currentView === 'dashboard') {
                updateDashboard();
            }
            NProgress.done();
        }, (error) => {
            console.error("Error fetching accounts: ", error);
            showToast("Error loading accounts. Check console.", 'danger');
            accountsTableBody.innerHTML = '<tr><td class="no-data" colspan="7" data-label="">Failed to load client data.</td></tr>';
            NProgress.done();
        });

        const salesQuery = query(collection(db, "sales"));
        unsubscribeSales = onSnapshot(salesQuery, (querySnapshot) => {
            sales = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            sales.forEach(sale => {
                const client = accounts.find(a => a.id === sale.clientId);
                sale.clientName = client ? client.name : 'Unknown Client';
                sale.status = sale.status || 'Paid'; 
            });
            renderSalesTable(sales);
            updateSortIcons('salesTable', salesSort);
            updateDashboard(); // Update dashboard on sales change
        }, (error) => {
            console.error("Error fetching sales: ", error);
            showToast("Error loading sales. Check console.", 'danger');
            salesTableBody.innerHTML = '<tr><td class="no-data" colspan="6" data-label="">Failed to load sales data.</td></tr>';
        });
    }

    function exportToCSV(type) {
        const isAccount = type === 'accounts';
        const data = isAccount ? accounts : sales;
        const filteredData = isAccount ? filterAccounts(data) : filterSales(data);
        if (filteredData.length === 0) {
            showToast('No data to export.', 'warning');
            return;
        }
        const headers = isAccount 
            ? ['Client Name', 'Email', 'Phone', 'Project Type', 'Date Added', 'Timezone', 'Account Type']
            : ['Client Name', 'Description', 'Amount', 'Status', 'Sale Date'];
        const rows = filteredData.map(item => {
            if (isAccount) {
                return [
                    `"${item.name.replace(/"/g, '""')}"`,
                    item.email,
                    `'${item.phone}`,
                    item.type,
                    item.dateAdded,
                    item.timezone,
                    item.category || 'New'
                ];
            } else {
                return [
                    `"${item.clientName.replace(/"/g, '""')}"`,
                    `"${item.description.replace(/"/g, '""')}"`,
                    item.amount,
                    item.status,
                    item.date
                ];
            }
        });
        let csvContent = headers.join(',') + '\n' + rows.map(e => e.join(',')).join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        const fileName = `${type.charAt(0).toUpperCase() + type.slice(1)}_Export_${moment().format('DD-MM-YY')}.csv`;
        link.setAttribute("href", url);
        link.setAttribute("download", fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast(`Successfully exported ${filteredData.length} ${type} to CSV.`, 'success');
    }

    // 6. Rendering Functions (Tables, Clocks, Tabs)

    function updateDigitalClock(tzLabel) {
        const tz = timezoneMap[tzLabel];
        const timeFormat = moment().tz(tz).format('hh:mm A');
        const digitalEl = document.getElementById(`digital-${tzLabel}`);
        const digitalElMobile = document.getElementById(`digital-${tzLabel}-mobile`);
        if (digitalEl) digitalEl.textContent = timeFormat;
        if (digitalElMobile) digitalElMobile.textContent = timeFormat;
    }

    function updateClocks() {
        Object.keys(timezoneMap).forEach(tz => {
            updateDigitalClock(tz);
        });
    }

    function initClocks() {
        updateClocks();
        setInterval(updateClocks, 1000);
    }

    function renderAccountsTable(data) {
        const sortedData = sortData([...data], accountSort.column, accountSort.direction);
        const filteredData = filterAccounts(sortedData);
        let accountRows;
        
        if (filteredData.length === 0) {
            accountRows = '<tr><td class="no-data" colspan="7" data-label="">No accounts found matching your criteria.</td></tr>';
        } else {
            accountRows = filteredData.map(account => `
                <tr data-id="${account.id}">
                    <td data-label="Client Name"><strong>${account.name}</strong></td>
                    <td data-label="Email">${account.email}</td>
                    <td data-label="Phone">${account.phone}</td>
                    <td data-label="Project Type">${account.type}</td>
                    <td data-label="Date Added">${moment(account.dateAdded).format('MMM Do, YYYY')}</td>
                    <td data-label="Timezone"><span class="badge timezone-badge">${account.timezone}</span></td>
                    <td data-label="Actions">
                        <div style="display: flex; gap: 5px; justify-content: flex-end;">
                            <button class="action-btn view-sales" title="View all sales for this account" onclick="viewAccountSales('${account.id}', '${account.name}')"><i class="fas fa-eye"></i></button>
                            <button class="action-btn edit" title="Edit account" onclick="editAccount('${account.id}')"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete" title="Delete account" onclick="deleteAccount('${account.id}', '${account.name}')"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        accountsTableBody.innerHTML = accountRows;
        resultsCount.textContent = `${filteredData.length} Account${filteredData.length !== 1 ? 's' : ''}`;
        updateAccountsMonthTabs(data);
    }

    function updateAccountsMonthTabs(data) {
        const monthMap = {};
        const otherAccounts = data.filter(acc => acc.category === 'Other');
        const newAccounts = data.filter(acc => acc.category !== 'Other');

        newAccounts.forEach(account => {
            const date = moment(account.dateAdded);
            const key = date.format('YYYY-M'); 
            const label = date.format("MMM 'YY");
            if (!monthMap[key]) {
                monthMap[key] = { key, label, count: 0 };
            }
            monthMap[key].count++;
        });

        const sortedMonths = Object.values(monthMap).sort((a, b) => {
            return moment(b.key, 'YYYY-M').valueOf() - moment(a.key, 'YYYY-M').valueOf();
        });

        const allTab = `<a class="month-tab ${currentAccountMonthFilter === 'All' ? 'active' : ''}"
    data-month="All"
    role="tab"
    aria-selected="${currentAccountMonthFilter === 'All'}"
    tabindex="0">
    All (${newAccounts.length})
</a>`;

        const otherTab = `<a class="month-tab ${currentAccountMonthFilter === 'Other' ? 'active' : ''}" data-month="Other" role="tab" aria-selected="${currentAccountMonthFilter === 'Other'}" tabindex="0">Other (${otherAccounts.length})</a>`;

        const monthTabs = sortedMonths.map(month => {
            const isActive = currentAccountMonthFilter === month.key;
            return `<a class="month-tab ${isActive ? 'active' : ''}" data-month="${month.key}" role="tab" aria-selected="${isActive}" tabindex="0">${month.label} (${month.count})</a>`;
        }).join('');

        accountsMonthTabsContainer.innerHTML = allTab + otherTab + monthTabs;
    }

    function renderSalesTable(data) {
        const sortedData = sortData([...data], salesSort.column, salesSort.direction);
        const filteredData = filterSales(sortedData);
        let salesRows;

        if (filteredData.length === 0) {
            salesRows = '<tr><td class="no-data" colspan="6" data-label="">No sales found matching your criteria.</td></tr>';
        } else {
            salesRows = filteredData.map(sale => {
                const amountDisplay = formatCurrency(sale.amount);
                const statusClass = sale.status.toLowerCase();
                const statusBadge = `<span class="badge ${statusClass}">${sale.status}</span>`;
                const dateFormatted = moment(sale.date).format('MMM Do, YYYY');
                return `
                    <tr data-id="${sale.id}">
                        <td data-label="Client Name"><strong>${sale.clientName}</strong></td>
                        <td data-label="Description">${sale.description}</td>
                        <td data-label="Amount" style="font-weight: 600; color: var(--text-primary);">${amountDisplay}</td>
                        <td data-label="Status">${statusBadge}</td>
                        <td data-label="Sale Date">${dateFormatted}</td>
                        <td data-label="Actions">
                            <div style="display: flex; gap: 5px; justify-content: flex-end;">
                                <button class="action-btn edit" title="Edit sale" onclick="editSale('${sale.id}')"><i class="fas fa-edit"></i></button>
                                <button class="action-btn delete" title="Delete sale" onclick="deleteSale('${sale.id}', '${sale.clientName} - ${sale.description}')"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        salesTableBody.innerHTML = salesRows;
        salesResultsCount.textContent = `${filteredData.length} Sale${filteredData.length !== 1 ? 's' : ''}`;
        updateSalesMonthTabs(data);
    }

    function updateSalesMonthTabs(data) {
        const monthMap = {};
        data.forEach(sale => {
            const date = moment(sale.date);
            const key = date.format('YYYY-M'); 
            const label = date.format("MMM 'YY");
            if (!monthMap[key]) {
                monthMap[key] = { key, label, count: 0 };
            }
            monthMap[key].count++;
        });
        const sortedMonths = Object.values(monthMap).sort((a, b) => {
            return moment(b.key, 'YYYY-M').valueOf() - moment(a.key, 'YYYY-M').valueOf();
        });
        const allTab = `<a class="month-tab ${currentSalesMonthFilter === 'All' ? 'active' : ''}" data-month="All" role="tab" aria-selected="${currentSalesMonthFilter === 'All'}" tabindex="0">All (${data.length})</a>`;
        const monthTabs = sortedMonths.map(month => {
            const isActive = currentSalesMonthFilter === month.key;
            return `<a class="month-tab ${isActive ? 'active' : ''}" data-month="${month.key}" role="tab" aria-selected="${isActive}" tabindex="0">${month.label} (${month.count})</a>`;
        }).join('');
        salesMonthTabsContainer.innerHTML = allTab + monthTabs;
    }

    function renderSalesInAccountModal(salesData) {
        if (salesData.length === 0) {
            return '<tr><td colspan="4" class="no-data" data-label="">No sales found for this account.</td></tr>';
        }
        return salesData.map(sale => {
            const amountDisplay = formatCurrency(sale.amount);
            const statusClass = sale.status.toLowerCase();
            const statusBadge = `<span class="badge ${statusClass}">${sale.status}</span>`;
            const dateFormatted = moment(sale.date).format('MMM Do, YYYY');
            return `
                <tr>
                    <td data-label="Date">${dateFormatted}</td>
                    <td data-label="Description" style="padding-left: 0;">${sale.description}</td>
                    <td data-label="Amount" style="font-weight: 600;">${amountDisplay}</td>
                    <td data-label="Status">${statusBadge}</td>
                </tr>
            `;
        }).join('');
    }

    // --- DASHBOARD FUNCTIONS ---
    function updateDashboard() {
        if (!sales || !accounts) {
            populateDashboardMonthFilter([], []);
            renderDashboardStats([]);
            return;
        };

        populateDashboardMonthFilter(sales, accounts);
        const selectedMonth = dashboardMonthFilter.value;
        let filteredSales = sales;

        if (selectedMonth !== 'All') {
            const [year, month] = selectedMonth.split('-');
            const momentMonth = parseInt(month) - 1;
            const momentYear = parseInt(year);
            filteredSales = sales.filter(sale => {
                const date = moment(sale.date);
                return date.year() === momentYear && date.month() === momentMonth;
            });
        }
        
        renderDashboardStats(filteredSales);
        renderSalesChart(filteredSales);
    }

    /**
     * This function now scans BOTH sales and accounts to build the month list.
     */
    function populateDashboardMonthFilter(allSales, allAccounts) {
        const monthMap = {};
        
        allSales.forEach(sale => {
            const key = moment(sale.date).format('YYYY-M');
            const label = moment(sale.date).format("MMMM YYYY");
            if (!monthMap[key]) {
                monthMap[key] = { key, label };
            }
        });

        allAccounts.forEach(account => {
            const key = moment(account.dateAdded).format('YYYY-M');
            const label = moment(account.dateAdded).format("MMMM YYYY");
            if (!monthMap[key]) {
                monthMap[key] = { key, label };
            }
        });

        const sortedMonths = Object.values(monthMap).sort((a, b) => moment(b.key, 'YYYY-M').valueOf() - moment(a.key, 'YYYY-M').valueOf());
        
        const currentSelection = dashboardMonthFilter.value;
        dashboardMonthFilter.innerHTML = `<option value="All">All Time</option>` + sortedMonths.map(m => `<option value="${m.key}">${m.label}</option>`).join('');
        
        // Ensure selection is preserved if it still exists in the new list
        if (Array.from(dashboardMonthFilter.options).some(o => o.value === currentSelection)) {
             dashboardMonthFilter.value = currentSelection;
        } else {
             dashboardMonthFilter.value = 'All';
        }
    }

    function renderDashboardStats(data) {
        let gross = 0, chargebacks = 0, highestSale = { amount: 0 }, topClientMap = {};

        data.forEach(sale => {
            const amount = parseFloat(sale.amount);
            gross += amount;
            if (sale.status === 'Chargeback') chargebacks += amount;

            if (amount > highestSale.amount) {
                highestSale = { amount, clientName: sale.clientName, date: sale.date };
            }
            
            if (sale.status !== 'Chargeback') {
                topClientMap[sale.clientName] = (topClientMap[sale.clientName] || 0) + amount;
            }
        });
        
        const net = gross - chargebacks;
        dbGrossSales.textContent = formatCurrency(gross);
        dbNetSales.textContent = formatCurrency(net);
        dbChargebacks.textContent = formatCurrency(chargebacks);
        
        // Calculate New Accounts for the selected period
        const selectedMonth = dashboardMonthFilter.value;
        let filteredAccounts = accounts.filter(acc => acc.category !== 'Other'); // Only 'New' accounts

        if (selectedMonth !== 'All') {
            const [year, month] = selectedMonth.split('-');
            const momentMonth = parseInt(month) - 1;
            const momentYear = parseInt(year);
            filteredAccounts = filteredAccounts.filter(account => {
                const date = moment(account.dateAdded);
                return date.year() === momentYear && date.month() === momentMonth;
            });
        }
        dbTotalSales.textContent = filteredAccounts.length;

        const topClient = Object.entries(topClientMap).sort(([,a],[,b]) => b-a)[0];
        if (topClient) {
            dbTopClient.innerHTML = `<span class="value">${topClient[0]}</span><br><span class="label">Total: </span><span class="amount">${formatCurrency(topClient[1])}</span>`;
        } else {
            dbTopClient.innerHTML = `<span class="value">N/A</span>`;
        }

        if (highestSale.amount > 0) {
            dbHighestSale.innerHTML = `<span class="value">${formatCurrency(highestSale.amount)}</span><br><span class="label">by ${highestSale.clientName} on ${moment(highestSale.date).format('MMM Do, YY')}</span>`;
        } else {
            dbHighestSale.innerHTML = `<span class="value">N/A</span>`;
        }
    }

    function renderSalesChart(data) {
        const salesByDay = {};
        const chartColor = document.body.classList.contains('dark-mode') ? '#f3f4f6' : '#4b5563';
        const gridColor = document.body.classList.contains('dark-mode') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
        const primaryColor = document.body.classList.contains('dark-mode') ? '#a78bfa' : '#6d28d9';
        const primaryLight = document.body.classList.contains('dark-mode') ? 'rgba(167, 139, 250, 0.1)' : 'rgba(109, 40, 217, 0.1)';

        data.forEach(sale => {
            if (sale.status !== 'Chargeback') {
                const day = moment(sale.date).format('YYYY-MM-DD');
                salesByDay[day] = (salesByDay[day] || 0) + parseFloat(sale.amount);
            }
        });

        const sortedDays = Object.keys(salesByDay).sort((a, b) => moment(a).valueOf() - moment(b).valueOf());
        const labels = sortedDays.map(day => moment(day).format('MMM D'));
        const chartData = sortedDays.map(day => salesByDay[day]);

        if (salesChart) salesChart.destroy();

        salesChart = new Chart(salesChartCanvas, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Net Sales',
                    data: chartData,
                    backgroundColor: primaryLight,
                    borderColor: primaryColor,
                    borderWidth: 2,
                    pointBackgroundColor: primaryColor,
                    pointBorderColor: document.body.classList.contains('dark-mode') ? '#1e1e1e' : '#fff',
                    pointHoverRadius: 6,
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#000',
                        titleFont: { size: 14 },
                        bodyFont: { size: 12 },
                        callbacks: {
                            label: (context) => `Sales: ${formatCurrency(context.raw)}`
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: chartColor,
                            callback: (value) => formatCurrency(value)
                        },
                        grid: { color: gridColor }
                    },
                    x: {
                        ticks: { color: chartColor },
                        grid: { color: 'transparent' }
                    }
                }
            }
        });
    }
    // --- END DASHBOARD FUNCTIONS ---


    // 7. Modal Open Functions
    function openAccountModal(id = null) {
        editAccountId = id;
        accountForm.reset();
        const title = document.getElementById('modalTitle');
        const saveBtnText = document.getElementById('saveAccountBtnText');
        if (!id) {
            dateAddedInput.value = moment().format('YYYY-MM-DD'); 
            title.textContent = 'Add Account';
            saveBtnText.textContent = 'Save';
            document.getElementById('saveAccountBtn').classList.remove('update');
        } else {
            const account = accounts.find(a => a.id === id);
            if (account) {
                title.textContent = 'Edit Account';
                saveBtnText.textContent = 'Update';
                document.getElementById('saveAccountBtn').classList.add('update');
                document.getElementById('accountName').value = account.name;
                document.getElementById('accountEmail').value = account.email;
                document.getElementById('accountPhone').value = account.phone;
                document.getElementById('accountType').value = account.type;
                document.getElementById('dateAdded').value = account.dateAdded;
                document.getElementById('accountCategory').value = account.category || 'New'; // Default old accounts to 'New'
            }
        }
        openModal(accountModal);
        document.getElementById('accountName').focus();
    }

    function openSalesModal(id = null) {
        if (accounts.length === 0) {
            showToast('Please add an account before adding a sale.', 'warning');
            return;
        }
        editSaleId = id;
        salesForm.reset();
        saleClientSearchInput.value = '';
        saleClientIdInput.value = '';
        
        const title = document.getElementById('salesModalTitle');
        const saveBtnText = document.getElementById('saveSaleBtnText');
        const saleDateInput = document.getElementById('saleDate');
        const saleStatusSelect = document.getElementById('saleStatus');

        if (!id) {
            title.textContent = 'Add New Sale';
            saveBtnText.textContent = 'Save Sale';
            document.getElementById('saveSaleBtn').classList.remove('update');
            saleDateInput.value = moment().format('YYYY-MM-DD');
            saleStatusSelect.value = 'Paid';
        } else {
            const sale = sales.find(s => s.id === id);
            if (sale) {
                const client = accounts.find(a => a.id === sale.clientId);
                title.textContent = 'Edit Sale';
                saveBtnText.textContent = 'Update Sale';
                document.getElementById('saveSaleBtn').classList.add('update');
                
                if (client) {
                    saleClientSearchInput.value = client.name;
                    saleClientIdInput.value = client.id;
                }
                
                document.getElementById('saleDescription').value = sale.description;
                document.getElementById('saleAmount').value = sale.amount;
                document.getElementById('saleDate').value = sale.date;
                saleStatusSelect.value = sale.status;
            }
        }
        openModal(salesModal);
        saleClientSearchInput.focus();
    }
    
    // 8. Global Window Functions
    window.viewAccountSales = function(accountId, accountName) {
        viewSalesModalTitle.textContent = `All Sales for ${accountName}`;
        const accountSales = sales.filter(sale => sale.clientId === accountId);
        accountSalesTableBody.innerHTML = renderSalesInAccountModal(accountSales);
        openModal(viewSalesByAccountModal);
    }

    window.editAccount = openAccountModal;
    window.deleteAccount = deleteAccount;
    window.editSale = openSalesModal;
    window.deleteSale = deleteSale;

    // 9. Event Listeners

    accountForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        NProgress.start();
        const accountData = prepareAccountData(accountForm);
        try {
            if (editAccountId) {
                await setDoc(doc(db, "accounts", editAccountId), accountData);
                showToast(`Account "${accountData.name}" updated successfully!`, 'success');
            } else {
                await addDoc(collection(db, "accounts"), accountData);
                showToast(`Account "${accountData.name}" added successfully!`, 'success');
            }
            closeModal(accountModal);
        } catch (e) {
            console.error("Error adding/updating document: ", e);
            showToast("Error saving account data. Check console.", 'danger');
        } finally {
            NProgress.done();
        }
    });

    salesForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!salesForm.saleClientId.value) {
            showToast("Please select a valid client from the suggestions.", "danger");
            return;
        }
        NProgress.start();
        const saleData = prepareSaleData(salesForm);
        try {
            if (editSaleId) {
                await setDoc(doc(db, "sales", editSaleId), saleData);
                showToast(`Sale updated successfully!`, 'success');
            } else {
                await addDoc(collection(db, "sales"), saleData);
                showToast(`Sale added successfully!`, 'success');
            }
            closeModal(salesModal);
        } catch (e) {
            console.error("Error adding/updating sale document: ", e);
            showToast("Error saving sale data. Check console.", 'danger');
        } finally {
            NProgress.done();
        }
    });

    // --- Searchable Client Input Logic ---
    saleClientSearchInput.addEventListener('input', () => {
        const searchTerm = saleClientSearchInput.value.toLowerCase();
        saleClientIdInput.value = ''; 
        
        if (!searchTerm) {
            clientSuggestionsContainer.style.display = 'none';
            return;
        }

        const matchedAccounts = accounts.filter(acc => acc.name.toLowerCase().includes(searchTerm));
        
        clientSuggestionsContainer.innerHTML = '';
        if (matchedAccounts.length > 0) {
            matchedAccounts.forEach(acc => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = acc.name;
                item.dataset.id = acc.id;
                item.dataset.name = acc.name;
                clientSuggestionsContainer.appendChild(item);
            });
            clientSuggestionsContainer.style.display = 'block';
        } else {
            clientSuggestionsContainer.style.display = 'none';
        }
    });

    clientSuggestionsContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('suggestion-item')) {
            saleClientSearchInput.value = e.target.dataset.name;
            saleClientIdInput.value = e.target.dataset.id;
            clientSuggestionsContainer.style.display = 'none';
        }
    });

    document.addEventListener('click', (e) => {
        const container = salesModal.querySelector('.searchable-select-container');
        if (container && !container.contains(e.target)) {
            clientSuggestionsContainer.style.display = 'none';
        }
    });
    // --- End Searchable Client Input Logic ---

    // Modal Cancel Buttons
    cancelAccountBtn.onclick = () => closeModal(accountModal);
    cancelSaleBtn.onclick = () => closeModal(salesModal);
    cancelPasswordBtn.onclick = () => closeModal(changePasswordModal);
    closeViewSalesBtn.onclick = function() {
        closeModal(viewSalesByAccountModal);
        setTimeout(() => {
            accountSalesTableBody.innerHTML = '<tr><td colspan="4" class="no-data" data-label="">Loading sales data...</td></tr>';
        }, 300);
    }
    
    // Search & Filter Listeners
    searchInput.addEventListener('input', () => renderAccountsTable(accounts));
    salesSearchInput.addEventListener('input', () => renderSalesTable(sales));
    dashboardMonthFilter.addEventListener('change', updateDashboard);

    // Month Tab Listeners
    accountsMonthTabsContainer.addEventListener('click', (e) => {
        const target = e.target.closest('.month-tab');
        if (target) {
            document.querySelector('#accounts-view .table-wrapper').classList.add('data-reloading');
            
            setTimeout(() => {
                document.querySelectorAll('#accountsMonthTabsContainer .month-tab').forEach(tab => {
                    tab.classList.remove('active');
                    tab.setAttribute('aria-selected', 'false');
                });
                target.classList.add('active');
                target.setAttribute('aria-selected', 'true');
                currentAccountMonthFilter = target.getAttribute('data-month');
                renderAccountsTable(accounts);
                document.querySelector('#accounts-view .table-wrapper').classList.remove('data-reloading');
            }, 200);
        }
    });

    salesMonthTabsContainer.addEventListener('click', (e) => {
        const target = e.target.closest('.month-tab');
        if (target) {
            document.querySelector('#sales-view .table-wrapper').classList.add('data-reloading');
            
            setTimeout(() => {
                document.querySelectorAll('#salesMonthTabsContainer .month-tab').forEach(tab => {
                    tab.classList.remove('active');
                    tab.setAttribute('aria-selected', 'false');
                });
                target.classList.add('active');
                target.setAttribute('aria-selected', 'true');
                currentSalesMonthFilter = target.getAttribute('data-month'); 
                renderSalesTable(sales);
                document.querySelector('#sales-view .table-wrapper').classList.remove('data-reloading');
            }, 200);
        }
    });

    // Main Navigation
    allNavTabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
            e.preventDefault();
            const targetViewId = e.currentTarget.getAttribute('data-target');
            const activeTab = document.querySelector('.nav-tab.active');
            
            if (activeTab && activeTab.getAttribute('data-target') === targetViewId) {
                if(mobileMenu.classList.contains('open')) mobileMenu.classList.remove('open');
                return;
            }

            const activeViewId = activeTab.getAttribute('data-target');

            allNavTabs.forEach(t => t.classList.remove('active'));
            document.querySelectorAll(`.nav-tab[data-target="${targetViewId}"]`).forEach(t => t.classList.add('active'));
            
            const activeView = views[activeViewId];
            const targetView = views[targetViewId];
            
            activeView.classList.add('fade-out');
            
            setTimeout(() => {
                activeView.style.display = 'none';
                activeView.classList.remove('fade-out');
                targetView.style.display = 'block';

                currentView = targetViewId.replace('-view', '');

                fabBtn.style.display = (currentView === 'dashboard') ? 'none' : 'flex';

                if (currentView !== 'dashboard') {
                    fabBtn.classList.toggle('sales', currentView === 'sales');
                    fabBtn.setAttribute('data-type', currentView === 'sales' ? 'sales' : 'account');
                    fabBtn.setAttribute('aria-label', currentView === 'sales' ? 'Add sale' : 'Add account');
                }
                
                if (currentView === 'accounts') {
                    renderAccountsTable(accounts);
                    updateSortIcons('accountsTable', accountSort);
                } else if (currentView === 'sales') {
                    renderSalesTable(sales);
                    updateSortIcons('salesTable', salesSort);
                } else if (currentView === 'dashboard') {
                    updateDashboard();
                }
            }, 300);
            
            if(mobileMenu.classList.contains('open')) mobileMenu.classList.remove('open');
        });
    });

    // FAB Button
    fabBtn.addEventListener('click', () => {
        const type = fabBtn.getAttribute('data-type');
        if (type === 'account') {
            openAccountModal();
        } else if (type === 'sales') {
            openSalesModal();
        }
    });

    // Table Sorting
    document.querySelectorAll('#accountsTable thead th').forEach(th => {
        th.addEventListener('click', handleSort('accountsTable', accountSort, accounts, renderAccountsTable));
    });

    document.querySelectorAll('#salesTable thead th').forEach(th => {
        th.addEventListener('click', handleSort('salesTable', salesSort, sales, renderSalesTable));
    });

    // Phone Input Formatter
    document.getElementById('accountPhone').addEventListener('input', (e) => {
        const input = e.target;
        let cleaned = input.value.replace(/\D/g, '');
        let formatted = '';
        if (cleaned.length > 0) {
            formatted += '(' + cleaned.substring(0, 3);
        }
        if (cleaned.length > 3) {
            formatted += ') ' + cleaned.substring(3, 6);
        }
        if (cleaned.length > 6) {
            formatted += '-' + cleaned.substring(6, 10);
        }
        input.value = formatted;
    });

    // Table Cell Copying
    accountsTableBody.addEventListener('click', (e) => {
        const target = e.target.closest('td');
        if (!target) return;
        const cellIndex = target.cellIndex;
        let textToCopy = target.textContent.trim();
        let label = '';

        if (window.innerWidth <= 950) {
            label = target.getAttribute('data-label');
            if (label === 'Phone') {
                textToCopy = textToCopy.replace(/[\(\) -]/g, '');
            } else if (label !== 'Client Name' && label !== 'Email') {
                return;
            }
        } else {
             if (cellIndex === 0) {
                label = 'Client Name';
            } else if (cellIndex === 1) {
                label = 'Email';
            } else if (cellIndex === 2) {
                label = 'Phone';
                textToCopy = textToCopy.replace(/[\(\) -]/g, ''); 
            } else {
                return;
            }
        }
       
        if (textToCopy && label) {
            navigator.clipboard.writeText(textToCopy).then(() => {
                showToast(`${label} copied: ${textToCopy}`, 'info');
            }).catch(err => {
                showToast('Failed to copy text. Please try manually.', 'danger');
                console.error('Could not copy text: ', err);
            });
        }
    });
    
    // Export Buttons
    exportAccountsBtn.addEventListener('click', () => exportToCSV('accounts'));
    exportSalesBtn.addEventListener('click', () => exportToCSV('sales'));
    
    // --- NEW UI Listeners ---
    burgerToggle.addEventListener('click', () => mobileMenu.classList.add('open'));
    mobileMenuClose.addEventListener('click', () => mobileMenu.classList.remove('open'));

    themeToggleBtn.addEventListener('click', () => {
        const isDark = document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        updateThemeIcon(isDark);
        updateDashboard(); // Re-render chart with new colors
    });

    function updateThemeIcon(isDark) {
        const icon = themeToggleBtn.querySelector('i');
        if (isDark) {
            icon.className = 'fas fa-sun';
            themeToggleBtn.title = 'Toggle Light Mode';
            themeToggleBtn.classList.add('active');
        } else {
            icon.className = 'fas fa-moon';
            themeToggleBtn.title = 'Toggle Dark Mode';
            themeToggleBtn.classList.remove('active');
        }
    }

    function initTheme() {
        const savedTheme = localStorage.getItem('theme');
        const isDark = savedTheme === 'dark';
        if (isDark) {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }
        updateThemeIcon(isDark);
    }
    
    // --- Auth Listeners ---
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        NProgress.start();
        const email = loginForm.email.value;
        const password = loginForm.password.value;
        signInWithEmailAndPassword(auth, email, password)
            .then(userCredential => {
                localStorage.setItem('loginTimestamp', Date.now());
                showToast('Login successful!', 'success');
                loginForm.reset();
            })
            .catch(error => {
                console.error("Login failed:", error);
                showToast('Login failed. Please check your credentials.', 'danger');
            })
            .finally(() => {
                NProgress.done();
            });
    });
    
    const handleLogout = () => {
        appLayout.style.transition = 'opacity 0.3s ease';
        appLayout.style.opacity = '0';
        
        setTimeout(() => {
            localStorage.removeItem('loginTimestamp');
            signOut(auth).then(() => {
                showToast('You have been logged out.', 'info');
            }).catch(error => {
                console.error("Logout failed:", error);
                showToast('Logout failed. Please try again.', 'danger');
            }).finally(() => {
                appLayout.style.opacity = '1';
            });
        }, 300);
    };

    logoutBtn.addEventListener('click', handleLogout);
    logoutBtnMobile.addEventListener('click', handleLogout);

    const handleChangePassword = () => {
        changePasswordForm.reset();
        openModal(changePasswordModal);
        if(mobileMenu.classList.contains('open')) mobileMenu.classList.remove('open');
    };

    changePasswordBtn.addEventListener("click", handleChangePassword);
    changePasswordBtnMobile.addEventListener("click", handleChangePassword);

    changePasswordForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        NProgress.start();

        const user = auth.currentUser;
        const currentPassword = document.getElementById("currentPassword").value.trim();
        const newPassword = document.getElementById("newPassword").value.trim();
        const confirmPassword = document.getElementById("confirmPassword").value.trim();
        const updateBtn = document.getElementById("updatePasswordBtn");
        const modalBox = changePasswordModal.querySelector(".modal");

        modalBox.classList.add("processing");
        updateBtn.disabled = true;
        const originalText = updateBtn.innerHTML;
        updateBtn.innerHTML = `<span class="spinner"></span> Updating...`;

        try {
            if (newPassword.length < 6) throw { code: "weak-password" };
            if (newPassword !== confirmPassword) throw { code: "mismatch" };

            const { EmailAuthProvider, reauthenticateWithCredential, updatePassword } =
                await import("https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js");

            const credential = EmailAuthProvider.credential(user.email, currentPassword);
            await reauthenticateWithCredential(user, credential);
            await updatePassword(user, newPassword);

            updateBtn.classList.add("success-check");
            updateBtn.innerHTML = `<i class="fas fa-check"></i> Updated!`;
            showToast("Password updated successfully!", "success");

            await new Promise((res) => setTimeout(res, 1200));

            closeModal(changePasswordModal);
            changePasswordForm.reset();
        } catch (error) {
            console.error("Password update error:", error);
            if (error.code === "auth/wrong-password") {
                showToast("Current password is incorrect.", "danger");
            } else if (error.code === "weak-password") {
                showToast("Password must be at least 6 characters long.", "danger");
            } else if (error.code === "mismatch") {
                showToast("Passwords do not match.", "danger");
            } else {
                showToast("Failed to update password. Try again.", "danger");
            }
        } finally {
            NProgress.done();
            modalBox.classList.remove("processing");
            setTimeout(() => {
                updateBtn.disabled = false;
                updateBtn.classList.remove("success-check");
                updateBtn.innerHTML = originalText;
            }, 500);
        }
    });

    // 10. Initialization and Auth State Handler
    if (dateAddedInput) {
        dateAddedInput.value = moment().format('YYYY-MM-DD');
    }
    const saleDateInput = document.getElementById('saleDate');
    if (saleDateInput) {
        saleDateInput.value = moment().format('YYYY-MM-DD');
    }
    
    initTheme(); // Set theme on load

    onAuthStateChanged(auth, user => {
        globalLoader.classList.add('hidden');
        if (user) {
            const loginTime = localStorage.getItem('loginTimestamp');
            const NINE_HOURS_IN_MS = 9 * 60 * 60 * 1000;

            if (loginTime && (Date.now() - parseInt(loginTime) > NINE_HOURS_IN_MS)) {
                localStorage.removeItem('loginTimestamp');
                signOut(auth);
                showToast('Your session has expired. Please log in again.', 'info');
                return; 
            }

            loginPage.style.display = 'none';
            appLayout.style.display = 'flex';
            document.title = 'Account Management System | Dashboard';
            initClocks();
            subscribeToData();
            
            // Set initial view
            document.getElementById('dashboard-view').style.display = 'block';
            document.getElementById('accounts-view').style.display = 'none';
            document.getElementById('sales-view').style.display = 'none';
            fabBtn.style.display = 'none';
            allNavTabs.forEach(t => t.classList.remove('active'));
            document.querySelectorAll(`.nav-tab[data-target="dashboard-view"]`).forEach(t => t.classList.add('active'));

        } else {
            localStorage.removeItem('loginTimestamp');
            if (unsubscribeAccounts) unsubscribeAccounts();
            if (unsubscribeSales) unsubscribeSales();
            loginPage.style.display = 'flex';
            appLayout.style.display = 'none';
            document.title = 'Account Management System | Login';
            accounts = [];
            sales = [];
            renderAccountsTable([]);
            renderSalesTable([]);
        }
    });
</script>
</body>
</html>